<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>model API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>


            <h2>Contents</h2>
            <ul>
  <li><a href="#video-studio-project-model">Video Studio Project Model</a></li>
</ul>


            <h2>Submodules</h2>
            <ul>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#SEGMENT_ANYTHING_2_REPO_PATH">SEGMENT_ANYTHING_2_REPO_PATH</a>
            </li>
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="variable" href="#DEVICE">DEVICE</a>
            </li>
            <li>
                    <a class="variable" href="#MODEL_CONFIG">MODEL_CONFIG</a>
            </li>
            <li>
                    <a class="variable" href="#MODEL_CHECKPOINT">MODEL_CHECKPOINT</a>
            </li>
            <li>
                    <a class="variable" href="#MAX_FRAMES_TO_TRACK">MAX_FRAMES_TO_TRACK</a>
            </li>
            <li>
                    <a class="variable" href="#PROMPT_TYPE">PROMPT_TYPE</a>
            </li>
            <li>
                    <a class="variable" href="#ANNOTATION_WORKAROUND">ANNOTATION_WORKAROUND</a>
            </li>
            <li>
                    <a class="variable" href="#DEBUG">DEBUG</a>
            </li>
            <li>
                    <a class="variable" href="#LABEL_STUDIO_API_KEY">LABEL_STUDIO_API_KEY</a>
            </li>
            <li>
                    <a class="function" href="#get_inference_state">get_inference_state</a>
            </li>
            <li>
                    <a class="class" href="#NewModel">NewModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NewModel.split_frames">split_frames</a>
                        </li>
                        <li>
                                <a class="function" href="#NewModel.get_prompts">get_prompts</a>
                        </li>
                        <li>
                                <a class="function" href="#NewModel.convert_mask_to_bbox">convert_mask_to_bbox</a>
                        </li>
                        <li>
                                <a class="function" href="#NewModel.dump_image_with_mask">dump_image_with_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#NewModel.predict">predict</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
model    </h1>

                        <div class="docstring"><h1 id="video-studio-project-model">Video Studio Project Model</h1>

<p>This module defines a custom Label Studio ML Backend model that integrates with the
Segment-Anything-2 (SAM2) model for video object segmentation and tracking.</p>

<p>By leveraging SAM2, the model can propagate object masks through frames of a video,
updating annotations in Label Studio. It supports different prompt types (box or point)
and handles caching of inference states for efficient repeated predictions.</p>

<p>Environment variables:</p>

<ul>
<li>SEGMENT_ANYTHING_2_REPO_PATH: Path to the SAM2 repository (default: 'segment-anything-2').</li>
<li>DEVICE: The computation device ('cuda' or 'cpu', default: 'cuda').</li>
<li>MODEL_CONFIG: Path to the SAM2 model config file (default: './configs/sam2.1/sam2.1_hiera_t.yaml').</li>
<li>MODEL_CHECKPOINT: Name of the SAM2 checkpoint file (default: 'sam2.1_hiera_tiny.pt').</li>
<li>MAX_FRAMES_TO_TRACK: Maximum number of frames to track at once (default: 10).</li>
<li>PROMPT_TYPE: Prompt type for object initialization ('box' or 'point', default: 'box').</li>
<li>ANNOTATION_WORKAROUND: Enables workaround for annotation updates in Label Studio (default: False).</li>
<li>DEBUG: Enables debug output and frame dumping (default: False).</li>
<li>LABEL_STUDIO_API_KEY: API key for Label Studio if annotation workaround is used.</li>
</ul>
</div>

                        <input id="mod-model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-model-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Video Studio Project Model</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">==========================</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">This module defines a custom Label Studio ML Backend model that integrates with the</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">Segment-Anything-2 (SAM2) model for video object segmentation and tracking.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">By leveraging SAM2, the model can propagate object masks through frames of a video,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">updating annotations in Label Studio. It supports different prompt types (box or point)</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">and handles caching of inference states for efficient repeated predictions.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">Environment variables:</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">- SEGMENT_ANYTHING_2_REPO_PATH: Path to the SAM2 repository (default: &#39;segment-anything-2&#39;).</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">- DEVICE: The computation device (&#39;cuda&#39; or &#39;cpu&#39;, default: &#39;cuda&#39;).</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">- MODEL_CONFIG: Path to the SAM2 model config file (default: &#39;./configs/sam2.1/sam2.1_hiera_t.yaml&#39;).</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">- MODEL_CHECKPOINT: Name of the SAM2 checkpoint file (default: &#39;sam2.1_hiera_tiny.pt&#39;).</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">- MAX_FRAMES_TO_TRACK: Maximum number of frames to track at once (default: 10).</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">- PROMPT_TYPE: Prompt type for object initialization (&#39;box&#39; or &#39;point&#39;, default: &#39;box&#39;).</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">- ANNOTATION_WORKAROUND: Enables workaround for annotation updates in Label Studio (default: False).</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">- DEBUG: Enables debug output and frame dumping (default: False).</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">- LABEL_STUDIO_API_KEY: API key for Label Studio if annotation workaround is used.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span> <span class="nn">pathlib</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span> <span class="nn">tempfile</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">cast</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">import</span> <span class="nn">cv2</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="kn">from</span> <span class="nn">label_studio_ml.model</span> <span class="kn">import</span> <span class="n">LabelStudioMLBase</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="kn">from</span> <span class="nn">label_studio_ml.response</span> <span class="kn">import</span> <span class="n">ModelResponse</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="kn">from</span> <span class="nn">label_studio_sdk._extensions.label_studio_tools.core.utils.io</span> <span class="kn">import</span> <span class="n">get_local_path</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="kn">from</span> <span class="nn">label_studio_sdk.label_interface.objects</span> <span class="kn">import</span> <span class="n">PredictionValue</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="kn">from</span> <span class="nn">label_studio_sdk.client</span> <span class="kn">import</span> <span class="n">LabelStudio</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="c1"># read the environment variables and set the paths just before importing the sam2 module</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="n">SEGMENT_ANYTHING_2_REPO_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SEGMENT_ANYTHING_2_REPO_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;segment-anything-2&#39;</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SEGMENT_ANYTHING_2_REPO_PATH</span><span class="p">)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEVICE&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="n">MODEL_CONFIG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MODEL_CONFIG&#39;</span><span class="p">,</span> <span class="s1">&#39;./configs/sam2.1/sam2.1_hiera_t.yaml&#39;</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="n">MODEL_CHECKPOINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MODEL_CHECKPOINT&#39;</span><span class="p">,</span> <span class="s1">&#39;sam2.1_hiera_tiny.pt&#39;</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="n">MAX_FRAMES_TO_TRACK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAX_FRAMES_TO_TRACK&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="n">PROMPT_TYPE</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PROMPT_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">))</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="n">ANNOTATION_WORKAROUND</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ANNOTATION_WORKAROUND&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="n">LABEL_STUDIO_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;LABEL_STUDIO_API_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="c1"># Mock heavy dependencies when generating documentation</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="k">if</span> <span class="s2">&quot;pdoc&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;torch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;cv2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;sam2.build_sam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">predictor</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="kn">from</span> <span class="nn">sam2.build_sam</span> <span class="kn">import</span> <span class="n">build_sam2</span><span class="p">,</span> <span class="n">build_sam2_video_predictor</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="c1"># Function to initialize autocast for CUDA</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    <span class="k">def</span> <span class="nf">initialize_autocast</span><span class="p">():</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">        Initialize automatic mixed-precision casting for CUDA.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        </span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        If DEVICE is &#39;cuda&#39;, it enables bfloat16 autocast mode and,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        on Ampere GPUs or newer, turns on TF32 computations for improved performance.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>            <span class="c1"># Use bfloat16 for the entire script</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>                <span class="c1"># Enable tfloat32 for Ampere GPUs</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="c1"># Build path to the model checkpoint</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="n">sam2_checkpoint</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">SEGMENT_ANYTHING_2_REPO_PATH</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="n">MODEL_CHECKPOINT</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model checkpoint: </span><span class="si">{</span><span class="n">sam2_checkpoint</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model config: </span><span class="si">{</span><span class="n">MODEL_CONFIG</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="c1"># Initialize autocast and predictor only when running normally</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="n">initialize_autocast</span><span class="p">()</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="n">predictor</span> <span class="o">=</span> <span class="n">build_sam2_video_predictor</span><span class="p">(</span><span class="n">MODEL_CONFIG</span><span class="p">,</span> <span class="n">sam2_checkpoint</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="c1"># manage cache for inference state</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="c1"># TODO: make it process-safe and implement cache invalidation</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="n">_predictor_state_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="n">_inference_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="k">def</span> <span class="nf">get_inference_state</span><span class="p">(</span><span class="n">video_dir</span><span class="p">):</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">    Retrieve or initialize the inference state for a given video directory.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    </span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">    Parameters</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">    ----------</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">    video_dir : str</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        The directory containing extracted frames for the video.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">    Returns</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">    -------</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    dict</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        The inference state dictionary used by the SAM2 predictor.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="k">global</span> <span class="n">_predictor_state_key</span><span class="p">,</span> <span class="n">_inference_state</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="k">if</span> <span class="n">_predictor_state_key</span> <span class="o">!=</span> <span class="n">video_dir</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">_predictor_state_key</span> <span class="o">=</span> <span class="n">video_dir</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">_inference_state</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">init_state</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_dir</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="k">return</span> <span class="n">_inference_state</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">LabelStudioMLBase</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    Custom ML Backend model that integrates with SAM2 for video object segmentation.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">    This model receives video annotation tasks from Label Studio, extracts prompts (box or point),</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    and uses SAM2 to track objects through frames. It updates annotations in Label Studio and can</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    handle multi-object tracking and propagation of segmentation masks.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="nf">split_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="n">start_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        Extract frames from a video file and save them as images in a temporary directory.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        This generator function reads frames from `video_path`, starting from `start_frame` up to</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        (but not including) `end_frame`. Each frame is saved as a JPEG image in `temp_dir` and yielded</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        as `(frame_filename, frame)`.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        Parameters</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        ----------</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        video_path : str</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">            Path to the input video file.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        temp_dir : str</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">            Directory where extracted frames will be saved.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        start_frame : int, optional</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            Index of the first frame to extract (default 0).</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        end_frame : int, optional</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            Index of the frame at which to stop extraction (non-inclusive, default 100).</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        Yields</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        ------</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">        tuple of (str, np.ndarray)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            `(frame_filename, frame)`, where `frame_filename` is the path to the saved frame image</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">            and `frame` is the frame data as a NumPy array.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        Raises</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        ------</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        ValueError</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">            If the video file cannot be opened.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">        Notes</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        -----</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">        - Frames are saved as JPEG images with zero-padded filenames.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        - Uses OpenCV (`cv2`) for video operations.</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        - If a frame file already exists, it is not overwritten.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opening video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fps: </span><span class="si">{</span><span class="n">fps</span><span class="si">}</span><span class="s1">, frame_count: </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">frame_count</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">video</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of frames: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to read frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                <span class="c1"># manage this (frame 57 of acutal video test)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                <span class="c1"># poi risovli il problema del label con diverse etichette</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                <span class="k">break</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&lt;</span> <span class="n">start_frame</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                <span class="k">continue</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;=</span> <span class="n">end_frame</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                <span class="k">break</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>            <span class="n">frame_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frame_count</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">):</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">frame_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>            <span class="k">yield</span> <span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        Extract prompts from the annotation context for use with the SAM2 model.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        Parameters</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">        ----------</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        context : dict</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            A dictionary containing annotation results, including frame-based bounding boxes or points.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">            The format is typically from Label Studio&#39;s `drafts` or `context`, with a &#39;result&#39; key.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        Returns</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        -------</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        List[Dict]</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            A list of prompt dictionaries. Each contains:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            - &#39;points&#39;: np.ndarray of keypoints/box coords</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            - &#39;labels&#39;: np.ndarray or None (for point prompts)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">            - &#39;frame_idx&#39;: int zero-based frame index</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            - &#39;obj_id&#39;: str object identifier</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        Raises</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        ------</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        ValueError</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">            If PROMPT_TYPE is neither &#39;point&#39; nor &#39;box&#39;.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting keypoints from context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="c1"># Process each video tracking object separately</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">obj_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                <span class="n">box_width</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">box_height</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                    <span class="c1"># SAM2 video works with keypoints - convert the rectangle to the set of keypoints within the rectangle</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                    <span class="c1"># bbox (x, y) is top-left corner</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                        <span class="c1"># center of the bbox</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                        <span class="c1"># half of the bbox width to the left</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                        <span class="c1"># half of the bbox width to the right</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                        <span class="c1"># half of the bbox height to the top</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                        <span class="c1"># half of the bbox height to the bottom</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                    <span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                    <span class="c1"># SAM2 video works with boxes - use the rectangle inf xyxy format</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span><span class="p">]</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid prompt type: </span><span class="si">{</span><span class="n">PROMPT_TYPE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="c1"># labels are not used for box prompts</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    <span class="s1">&#39;frame_idx&#39;</span><span class="p">:</span> <span class="n">frame_idx</span><span class="p">,</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                    <span class="s1">&#39;obj_id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                <span class="p">})</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">return</span> <span class="n">prompts</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>    <span class="k">def</span> <span class="nf">_get_fps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        Extract frames per second (FPS) and duration from the context.</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        Parameters</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        ----------</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        context : dict</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">            Annotation context containing &#39;framesCount&#39; and &#39;duration&#39;.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        Returns</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        -------</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        tuple of (int, float)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">            frames_count, duration</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="c1"># get the fps from the context</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">frames_count</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;framesCount&#39;</span><span class="p">]</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">return</span> <span class="n">frames_count</span><span class="p">,</span> <span class="n">duration</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="c1"># def convert_mask_to_bbox(self, mask):</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="c1">#     # convert mask to bbox</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>    <span class="c1">#     h, w = mask.shape[-2:]</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    <span class="c1">#     mask_int = mask.reshape(h, w, 1).astype(np.uint8)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="c1">#     contours, _ = cv2.findContours(mask_int, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="c1">#     if len(contours) == 0:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="c1">#         return None</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>    <span class="c1">#     x, y, w, h = cv2.boundingRect(contours[0])</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="c1">#     return {</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="c1">#         &#39;x&#39;: x,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>    <span class="c1">#         &#39;y&#39;: y,</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>    <span class="c1">#         &#39;width&#39;: w,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="c1">#         &#39;height&#39;: h</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    <span class="c1">#     }</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">convert_mask_to_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        Convert a binary mask to a bounding box in normalized percentages.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        Parameters</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        ----------</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">            A binary mask of shape (H, W) where 1 indicates object pixels.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        Returns</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        -------</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">        dict or None</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">            A dictionary with keys &#39;x&#39;, &#39;y&#39;, &#39;width&#39;, &#39;height&#39; representing the bounding box in percentage,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">            or None if no object pixels are found.</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="c1"># squeeze</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">y_indices</span><span class="p">,</span> <span class="n">x_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="c1"># Find the min and max indices</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="c1"># Get mask dimensions</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="c1"># Calculate bounding box dimensions</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="n">box_width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="n">box_height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="c1"># Normalize and scale to percentage</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="n">x_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="n">y_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">width_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">height_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_height</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">width_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">height_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="p">}</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">dump_image_with_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        Debug utility to overlay a mask onto a frame and save it as an image file.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        Parameters</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        ----------</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        frame : np.ndarray</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">            The original frame image (H, W, C).</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">            A binary mask for the object (H, W).</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        output_file : str</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">            Path to save the output image.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        obj_id : int, optional</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">            Object identifier to pick a color from a colormap.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        random_color : bool, optional</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">            If True, use a random color for the mask overlay.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">random_color</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.6</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="n">cmap_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">obj_id</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">cmap_idx</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">])</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="c1"># create an image file to display image overlayed with mask</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGRA2BGR</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapes: frame=</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask_image=</span><span class="si">{</span><span class="n">mask_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="c1"># save in file</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving image with mask to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelResponse</span><span class="p">:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        Run the prediction to generate segmentation masks for a given set of video frames.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        The model:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        1. Extracts prompts (boxes/points) from the given tasks and drafts.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        2. Uses the SAM2 predictor to track the object(s) through frames.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        3. Updates annotations in Label Studio with the new masks and bounding boxes.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        Parameters</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        ----------</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">        tasks : list of dict</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">            List of tasks to be annotated, each containing video data and drafts or annotations.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        context : dict, optional</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">            Additional context with annotation results. If no drafts are found, context is used as a fallback.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">        **kwargs</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">            Additional keyword arguments (unused).</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        Returns</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        -------</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        ModelResponse</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">            A structured response containing updated annotations for Label Studio.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="n">from_name</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_tag_occurence</span><span class="p">(</span><span class="s1">&#39;VideoRectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;Video&#39;</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;drafts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Drafts not found, using annotations&#39;</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Annotations not found, using context&#39;</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">drafts</span><span class="p">):</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Draft empty, using context&#39;</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="c1"># Get the video URL from the task</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="n">video_url</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="c1"># cache the video locally</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">video_path</span> <span class="o">=</span> <span class="n">get_local_path</span><span class="p">(</span><span class="n">video_url</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video path: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="c1"># get prompts from context</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="c1"># prompts = self.get_prompts(context)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prompts</span><span class="p">(</span><span class="n">drafts</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">context_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]])</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="n">all_obj_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="o">+</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                          <span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="p">[]))</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">context_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span> <span class="n">all_obj_ids</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="c1"># Returning here because the case where object ids in the context do not match the ids found in the annotations is not supported.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="c1"># This remains an open issue but is not considered a substantial problem.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Context id </span><span class="si">{</span><span class="n">context_ids</span><span class="si">}</span><span class="s1"> not found in drafts result: </span><span class="si">{</span><span class="n">all_obj_ids</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                                      <span class="sa">f</span><span class="s1">&#39;TODO merge context and drafts&#39;</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="c1"># create a map from obj_id to integer</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="n">obj_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)}</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="c1"># find the last frame index</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="c1"># if there is only one object, use the last frame of the object: continue tracking from last tracked frame</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="c1"># if there are multiple objects, use the smallest frame index of all objects</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="c1"># the minimum of the maximum frame_idx of all objects grouped by id</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">frames_count</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">frames_count</span> <span class="o">/</span> <span class="n">duration</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="sa">f</span><span class="s1">&#39;Number of prompts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="sa">f</span><span class="s1">&#39;first frame index: </span><span class="si">{</span><span class="n">first_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="sa">f</span><span class="s1">&#39;last frame index: </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="sa">f</span><span class="s1">&#39;obj_ids: </span><span class="si">{</span><span class="n">obj_ids</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="n">frames_to_track</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_FRAMES_TO_TRACK</span><span class="p">,</span> <span class="n">frames_count</span> <span class="o">-</span> <span class="n">last_frame_idx</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="c1"># Split the video into frames</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="c1"># # use persisted dir for debug</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="c1"># temp_dir = &#39;/tmp/frames&#39;</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="c1"># os.makedirs(temp_dir, exist_ok=True)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="c1"># get all frames</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_frames</span><span class="p">(</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="n">start_frame</span><span class="o">=</span><span class="n">first_frame_idx</span><span class="p">,</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                <span class="n">end_frame</span><span class="o">=</span><span class="n">last_frame_idx</span> <span class="o">+</span> <span class="n">frames_to_track</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="p">))</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video width=</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">, height=</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="c1"># get inference state</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="n">inference_state</span> <span class="o">=</span> <span class="n">get_inference_state</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">predictor</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span><span class="n">inference_state</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="c1"># Group prompts by &#39;obj_id&#39; and sort them by &#39;frame_idx&#39; in one step</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="n">prompt_id_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="p">[</span><span class="n">prompt_id_dict</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="c1"># Sort the prompts and extract the highest frame index for each object ID</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="n">highest_frames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prompts</span> <span class="ow">in</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                              <span class="n">prompt_id_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="c1"># Get the minimum value of the highest frame indices</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="n">prompt_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">highest_frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">highest_frames</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_frame_idx</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                <span class="c1"># sam 2 not predict other frame if are present prompts after the frame: the prompt must be set in the same frame for each object</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="k">if</span> <span class="n">frame_idx</span> <span class="o">&gt;</span> <span class="n">prompt_idx</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prompt frame index </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s1"> is out of bounds&#39;</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>                    <span class="k">continue</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                        <span class="n">points</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>                        <span class="n">labels</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                    <span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                        <span class="n">box</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                    <span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>              <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;./debug-frames&#39;</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>              <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Propagating in video from frame </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">frames_to_track</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="k">for</span> <span class="n">out_frame_idx</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="ow">in</span> <span class="n">predictor</span><span class="o">.</span><span class="n">propagate_in_video</span><span class="p">(</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="n">start_frame_idx</span><span class="o">=</span><span class="n">last_frame_idx</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="n">max_frame_num_to_track</span><span class="o">=</span><span class="n">frames_to_track</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="p">):</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="n">real_frame_idx</span> <span class="o">=</span> <span class="n">out_frame_idx</span> <span class="o">+</span> <span class="n">first_frame_idx</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out_obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_obj_ids</span><span class="p">):</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_mask_logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                      <span class="c1"># to debug, save the mask as an image</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                      <span class="bp">self</span><span class="o">.</span><span class="n">dump_image_with_mask</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">out_frame_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">debug_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">out_frame_idx</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">out_obj_id</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">out_obj_id</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                    <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_mask_to_bbox</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                    <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                        <span class="n">obj_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">out_obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>                            <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">real_frame_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>                            <span class="c1"># &#39;x&#39;: bbox[&#39;x&#39;] / width * 100,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                            <span class="c1"># &#39;y&#39;: bbox[&#39;y&#39;] / height * 100,</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                            <span class="c1"># &#39;width&#39;: bbox[&#39;width&#39;] / width * 100,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>                            <span class="c1"># &#39;height&#39;: bbox[&#39;height&#39;] / height * 100,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>                            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>                            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                            <span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">out_frame_idx</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                        <span class="p">})</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                <span class="c1"># find the context to use by searching on drafts by obj_id</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="n">context_result_sequence</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="p">[])</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="c1"># take the old sequence only for the frames before the first frame of the new sequence</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                <span class="c1"># and after the last frame of the new sequence</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span> <span class="o">+</span> \
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                               <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                               <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                <span class="c1"># take the old labels: take from context if present, otherwise from drafts</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                         <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                        <span class="s1">&#39;framesCount&#39;</span><span class="p">:</span> <span class="n">frames_count</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                        <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">new_sequence</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">labels</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                    <span class="p">},</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                    <span class="s1">&#39;from_name&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                    <span class="s1">&#39;to_name&#39;</span><span class="p">:</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;videorectangle&#39;</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                    <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                <span class="p">})</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="n">prediction</span> <span class="o">=</span> <span class="n">PredictionValue</span><span class="p">(</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                <span class="n">model_version</span><span class="o">=</span><span class="n">MODEL_CHECKPOINT</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction: </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>              <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prediction.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                  <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="k">if</span> <span class="n">ANNOTATION_WORKAROUND</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                <span class="c1"># this is a workaround to update the annotation in the Label Studio since using the model response shows all the objects with the same label</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>                <span class="c1"># also if the label is different for each object</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                <span class="n">client</span> <span class="o">=</span> <span class="n">LabelStudio</span><span class="p">(</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">LABEL_STUDIO_API_KEY</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating new annotation&#39;</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                    <span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                    <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating annotation: </span><span class="si">{</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;annotations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                    <span class="p">)</span> <span class="c1"># perche se non lo faccio nella UI mette tutti gli oggetti con la stessa label! sempre!</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="c1"># convert annotation to draft making POST request to http://&lt;IP&gt;/api/annotations/{id}/convert-to-draft</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_URL&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/api/annotations/</span><span class="si">{</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">/convert-to-draft&#39;</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                    <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_API_KEY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                <span class="p">}</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>            <span class="c1"># raise NotImplementedError(&#39;Stop here&#39;)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>            <span class="k">return</span> <span class="n">ModelResponse</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="p">[</span><span class="n">prediction</span><span class="p">])</span>
</span></pre></div>


            </section>
                <section id="SEGMENT_ANYTHING_2_REPO_PATH">
                    <div class="attr variable">
            <span class="name">SEGMENT_ANYTHING_2_REPO_PATH</span>        =
<span class="default_value">&#39;segment-anything-2&#39;</span>

        
    </div>
    <a class="headerlink" href="#SEGMENT_ANYTHING_2_REPO_PATH"></a>
    
    

                </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger model (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="DEVICE">
                    <div class="attr variable">
            <span class="name">DEVICE</span>        =
<span class="default_value">&#39;cuda&#39;</span>

        
    </div>
    <a class="headerlink" href="#DEVICE"></a>
    
    

                </section>
                <section id="MODEL_CONFIG">
                    <div class="attr variable">
            <span class="name">MODEL_CONFIG</span>        =
<span class="default_value">&#39;./configs/sam2.1/sam2.1_hiera_t.yaml&#39;</span>

        
    </div>
    <a class="headerlink" href="#MODEL_CONFIG"></a>
    
    

                </section>
                <section id="MODEL_CHECKPOINT">
                    <div class="attr variable">
            <span class="name">MODEL_CHECKPOINT</span>        =
<span class="default_value">&#39;sam2.1_hiera_tiny.pt&#39;</span>

        
    </div>
    <a class="headerlink" href="#MODEL_CHECKPOINT"></a>
    
    

                </section>
                <section id="MAX_FRAMES_TO_TRACK">
                    <div class="attr variable">
            <span class="name">MAX_FRAMES_TO_TRACK</span>        =
<span class="default_value">10</span>

        
    </div>
    <a class="headerlink" href="#MAX_FRAMES_TO_TRACK"></a>
    
    

                </section>
                <section id="PROMPT_TYPE">
                    <div class="attr variable">
            <span class="name">PROMPT_TYPE</span>        =
<span class="default_value">&#39;box&#39;</span>

        
    </div>
    <a class="headerlink" href="#PROMPT_TYPE"></a>
    
    

                </section>
                <section id="ANNOTATION_WORKAROUND">
                    <div class="attr variable">
            <span class="name">ANNOTATION_WORKAROUND</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#ANNOTATION_WORKAROUND"></a>
    
    

                </section>
                <section id="DEBUG">
                    <div class="attr variable">
            <span class="name">DEBUG</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#DEBUG"></a>
    
    

                </section>
                <section id="LABEL_STUDIO_API_KEY">
                    <div class="attr variable">
            <span class="name">LABEL_STUDIO_API_KEY</span>        =
<span class="default_value">&#39;&#39;</span>

        
    </div>
    <a class="headerlink" href="#LABEL_STUDIO_API_KEY"></a>
    
    

                </section>
                <section id="get_inference_state">
                            <input id="get_inference_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_inference_state</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">video_dir</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_inference_state-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_inference_state"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_inference_state-101"><a href="#get_inference_state-101"><span class="linenos">101</span></a><span class="k">def</span> <span class="nf">get_inference_state</span><span class="p">(</span><span class="n">video_dir</span><span class="p">):</span>
</span><span id="get_inference_state-102"><a href="#get_inference_state-102"><span class="linenos">102</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_inference_state-103"><a href="#get_inference_state-103"><span class="linenos">103</span></a><span class="sd">    Retrieve or initialize the inference state for a given video directory.</span>
</span><span id="get_inference_state-104"><a href="#get_inference_state-104"><span class="linenos">104</span></a><span class="sd">    </span>
</span><span id="get_inference_state-105"><a href="#get_inference_state-105"><span class="linenos">105</span></a><span class="sd">    Parameters</span>
</span><span id="get_inference_state-106"><a href="#get_inference_state-106"><span class="linenos">106</span></a><span class="sd">    ----------</span>
</span><span id="get_inference_state-107"><a href="#get_inference_state-107"><span class="linenos">107</span></a><span class="sd">    video_dir : str</span>
</span><span id="get_inference_state-108"><a href="#get_inference_state-108"><span class="linenos">108</span></a><span class="sd">        The directory containing extracted frames for the video.</span>
</span><span id="get_inference_state-109"><a href="#get_inference_state-109"><span class="linenos">109</span></a>
</span><span id="get_inference_state-110"><a href="#get_inference_state-110"><span class="linenos">110</span></a><span class="sd">    Returns</span>
</span><span id="get_inference_state-111"><a href="#get_inference_state-111"><span class="linenos">111</span></a><span class="sd">    -------</span>
</span><span id="get_inference_state-112"><a href="#get_inference_state-112"><span class="linenos">112</span></a><span class="sd">    dict</span>
</span><span id="get_inference_state-113"><a href="#get_inference_state-113"><span class="linenos">113</span></a><span class="sd">        The inference state dictionary used by the SAM2 predictor.</span>
</span><span id="get_inference_state-114"><a href="#get_inference_state-114"><span class="linenos">114</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_inference_state-115"><a href="#get_inference_state-115"><span class="linenos">115</span></a>    <span class="k">global</span> <span class="n">_predictor_state_key</span><span class="p">,</span> <span class="n">_inference_state</span>
</span><span id="get_inference_state-116"><a href="#get_inference_state-116"><span class="linenos">116</span></a>    <span class="k">if</span> <span class="n">_predictor_state_key</span> <span class="o">!=</span> <span class="n">video_dir</span><span class="p">:</span>
</span><span id="get_inference_state-117"><a href="#get_inference_state-117"><span class="linenos">117</span></a>        <span class="n">_predictor_state_key</span> <span class="o">=</span> <span class="n">video_dir</span>
</span><span id="get_inference_state-118"><a href="#get_inference_state-118"><span class="linenos">118</span></a>        <span class="n">_inference_state</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">init_state</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_dir</span><span class="p">)</span>
</span><span id="get_inference_state-119"><a href="#get_inference_state-119"><span class="linenos">119</span></a>    <span class="k">return</span> <span class="n">_inference_state</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve or initialize the inference state for a given video directory.</p>

<h2 id="parameters">Parameters</h2>

<p>video_dir : str
    The directory containing extracted frames for the video.</p>

<h2 id="returns">Returns</h2>

<p>dict
    The inference state dictionary used by the SAM2 predictor.</p>
</div>


                </section>
                <section id="NewModel">
                            <input id="NewModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NewModel</span><wbr>(<span class="base">label_studio_ml.model.LabelStudioMLBase</span>):

                <label class="view-source-button" for="NewModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel-121"><a href="#NewModel-121"><span class="linenos">121</span></a><span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">LabelStudioMLBase</span><span class="p">):</span>
</span><span id="NewModel-122"><a href="#NewModel-122"><span class="linenos">122</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-123"><a href="#NewModel-123"><span class="linenos">123</span></a><span class="sd">    Custom ML Backend model that integrates with SAM2 for video object segmentation.</span>
</span><span id="NewModel-124"><a href="#NewModel-124"><span class="linenos">124</span></a>
</span><span id="NewModel-125"><a href="#NewModel-125"><span class="linenos">125</span></a><span class="sd">    This model receives video annotation tasks from Label Studio, extracts prompts (box or point),</span>
</span><span id="NewModel-126"><a href="#NewModel-126"><span class="linenos">126</span></a><span class="sd">    and uses SAM2 to track objects through frames. It updates annotations in Label Studio and can</span>
</span><span id="NewModel-127"><a href="#NewModel-127"><span class="linenos">127</span></a><span class="sd">    handle multi-object tracking and propagation of segmentation masks.</span>
</span><span id="NewModel-128"><a href="#NewModel-128"><span class="linenos">128</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NewModel-129"><a href="#NewModel-129"><span class="linenos">129</span></a>    
</span><span id="NewModel-130"><a href="#NewModel-130"><span class="linenos">130</span></a>
</span><span id="NewModel-131"><a href="#NewModel-131"><span class="linenos">131</span></a>    <span class="k">def</span> <span class="nf">split_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="n">start_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="NewModel-132"><a href="#NewModel-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-133"><a href="#NewModel-133"><span class="linenos">133</span></a><span class="sd">        Extract frames from a video file and save them as images in a temporary directory.</span>
</span><span id="NewModel-134"><a href="#NewModel-134"><span class="linenos">134</span></a>
</span><span id="NewModel-135"><a href="#NewModel-135"><span class="linenos">135</span></a><span class="sd">        This generator function reads frames from `video_path`, starting from `start_frame` up to</span>
</span><span id="NewModel-136"><a href="#NewModel-136"><span class="linenos">136</span></a><span class="sd">        (but not including) `end_frame`. Each frame is saved as a JPEG image in `temp_dir` and yielded</span>
</span><span id="NewModel-137"><a href="#NewModel-137"><span class="linenos">137</span></a><span class="sd">        as `(frame_filename, frame)`.</span>
</span><span id="NewModel-138"><a href="#NewModel-138"><span class="linenos">138</span></a>
</span><span id="NewModel-139"><a href="#NewModel-139"><span class="linenos">139</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-140"><a href="#NewModel-140"><span class="linenos">140</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-141"><a href="#NewModel-141"><span class="linenos">141</span></a><span class="sd">        video_path : str</span>
</span><span id="NewModel-142"><a href="#NewModel-142"><span class="linenos">142</span></a><span class="sd">            Path to the input video file.</span>
</span><span id="NewModel-143"><a href="#NewModel-143"><span class="linenos">143</span></a><span class="sd">        temp_dir : str</span>
</span><span id="NewModel-144"><a href="#NewModel-144"><span class="linenos">144</span></a><span class="sd">            Directory where extracted frames will be saved.</span>
</span><span id="NewModel-145"><a href="#NewModel-145"><span class="linenos">145</span></a><span class="sd">        start_frame : int, optional</span>
</span><span id="NewModel-146"><a href="#NewModel-146"><span class="linenos">146</span></a><span class="sd">            Index of the first frame to extract (default 0).</span>
</span><span id="NewModel-147"><a href="#NewModel-147"><span class="linenos">147</span></a><span class="sd">        end_frame : int, optional</span>
</span><span id="NewModel-148"><a href="#NewModel-148"><span class="linenos">148</span></a><span class="sd">            Index of the frame at which to stop extraction (non-inclusive, default 100).</span>
</span><span id="NewModel-149"><a href="#NewModel-149"><span class="linenos">149</span></a>
</span><span id="NewModel-150"><a href="#NewModel-150"><span class="linenos">150</span></a><span class="sd">        Yields</span>
</span><span id="NewModel-151"><a href="#NewModel-151"><span class="linenos">151</span></a><span class="sd">        ------</span>
</span><span id="NewModel-152"><a href="#NewModel-152"><span class="linenos">152</span></a><span class="sd">        tuple of (str, np.ndarray)</span>
</span><span id="NewModel-153"><a href="#NewModel-153"><span class="linenos">153</span></a><span class="sd">            `(frame_filename, frame)`, where `frame_filename` is the path to the saved frame image</span>
</span><span id="NewModel-154"><a href="#NewModel-154"><span class="linenos">154</span></a><span class="sd">            and `frame` is the frame data as a NumPy array.</span>
</span><span id="NewModel-155"><a href="#NewModel-155"><span class="linenos">155</span></a>
</span><span id="NewModel-156"><a href="#NewModel-156"><span class="linenos">156</span></a><span class="sd">        Raises</span>
</span><span id="NewModel-157"><a href="#NewModel-157"><span class="linenos">157</span></a><span class="sd">        ------</span>
</span><span id="NewModel-158"><a href="#NewModel-158"><span class="linenos">158</span></a><span class="sd">        ValueError</span>
</span><span id="NewModel-159"><a href="#NewModel-159"><span class="linenos">159</span></a><span class="sd">            If the video file cannot be opened.</span>
</span><span id="NewModel-160"><a href="#NewModel-160"><span class="linenos">160</span></a>
</span><span id="NewModel-161"><a href="#NewModel-161"><span class="linenos">161</span></a><span class="sd">        Notes</span>
</span><span id="NewModel-162"><a href="#NewModel-162"><span class="linenos">162</span></a><span class="sd">        -----</span>
</span><span id="NewModel-163"><a href="#NewModel-163"><span class="linenos">163</span></a><span class="sd">        - Frames are saved as JPEG images with zero-padded filenames.</span>
</span><span id="NewModel-164"><a href="#NewModel-164"><span class="linenos">164</span></a><span class="sd">        - Uses OpenCV (`cv2`) for video operations.</span>
</span><span id="NewModel-165"><a href="#NewModel-165"><span class="linenos">165</span></a><span class="sd">        - If a frame file already exists, it is not overwritten.</span>
</span><span id="NewModel-166"><a href="#NewModel-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-167"><a href="#NewModel-167"><span class="linenos">167</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opening video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-168"><a href="#NewModel-168"><span class="linenos">168</span></a>        <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
</span><span id="NewModel-169"><a href="#NewModel-169"><span class="linenos">169</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
</span><span id="NewModel-170"><a href="#NewModel-170"><span class="linenos">170</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">)</span>
</span><span id="NewModel-171"><a href="#NewModel-171"><span class="linenos">171</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fps: </span><span class="si">{</span><span class="n">fps</span><span class="si">}</span><span class="s1">, frame_count: </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-172"><a href="#NewModel-172"><span class="linenos">172</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">frame_count</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="NewModel-173"><a href="#NewModel-173"><span class="linenos">173</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-174"><a href="#NewModel-174"><span class="linenos">174</span></a>
</span><span id="NewModel-175"><a href="#NewModel-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">video</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span><span id="NewModel-176"><a href="#NewModel-176"><span class="linenos">176</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NewModel-177"><a href="#NewModel-177"><span class="linenos">177</span></a>
</span><span id="NewModel-178"><a href="#NewModel-178"><span class="linenos">178</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of frames: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-179"><a href="#NewModel-179"><span class="linenos">179</span></a>
</span><span id="NewModel-180"><a href="#NewModel-180"><span class="linenos">180</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NewModel-181"><a href="#NewModel-181"><span class="linenos">181</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="NewModel-182"><a href="#NewModel-182"><span class="linenos">182</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="NewModel-183"><a href="#NewModel-183"><span class="linenos">183</span></a>
</span><span id="NewModel-184"><a href="#NewModel-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
</span><span id="NewModel-185"><a href="#NewModel-185"><span class="linenos">185</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to read frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-186"><a href="#NewModel-186"><span class="linenos">186</span></a>                <span class="c1"># manage this (frame 57 of acutal video test)</span>
</span><span id="NewModel-187"><a href="#NewModel-187"><span class="linenos">187</span></a>                <span class="c1"># poi risovli il problema del label con diverse etichette</span>
</span><span id="NewModel-188"><a href="#NewModel-188"><span class="linenos">188</span></a>                <span class="k">break</span>
</span><span id="NewModel-189"><a href="#NewModel-189"><span class="linenos">189</span></a>
</span><span id="NewModel-190"><a href="#NewModel-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&lt;</span> <span class="n">start_frame</span><span class="p">:</span>
</span><span id="NewModel-191"><a href="#NewModel-191"><span class="linenos">191</span></a>                <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="NewModel-192"><a href="#NewModel-192"><span class="linenos">192</span></a>                <span class="k">continue</span>
</span><span id="NewModel-193"><a href="#NewModel-193"><span class="linenos">193</span></a>
</span><span id="NewModel-194"><a href="#NewModel-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;=</span> <span class="n">end_frame</span><span class="p">:</span>
</span><span id="NewModel-195"><a href="#NewModel-195"><span class="linenos">195</span></a>                <span class="k">break</span>
</span><span id="NewModel-196"><a href="#NewModel-196"><span class="linenos">196</span></a>
</span><span id="NewModel-197"><a href="#NewModel-197"><span class="linenos">197</span></a>            <span class="n">frame_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frame_count</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span>
</span><span id="NewModel-198"><a href="#NewModel-198"><span class="linenos">198</span></a>
</span><span id="NewModel-199"><a href="#NewModel-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">):</span>
</span><span id="NewModel-200"><a href="#NewModel-200"><span class="linenos">200</span></a>                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</span><span id="NewModel-201"><a href="#NewModel-201"><span class="linenos">201</span></a>
</span><span id="NewModel-202"><a href="#NewModel-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">frame_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-203"><a href="#NewModel-203"><span class="linenos">203</span></a>            <span class="k">yield</span> <span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span>
</span><span id="NewModel-204"><a href="#NewModel-204"><span class="linenos">204</span></a>            <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="NewModel-205"><a href="#NewModel-205"><span class="linenos">205</span></a>
</span><span id="NewModel-206"><a href="#NewModel-206"><span class="linenos">206</span></a>        <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="NewModel-207"><a href="#NewModel-207"><span class="linenos">207</span></a>
</span><span id="NewModel-208"><a href="#NewModel-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="NewModel-209"><a href="#NewModel-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-210"><a href="#NewModel-210"><span class="linenos">210</span></a><span class="sd">        Extract prompts from the annotation context for use with the SAM2 model.</span>
</span><span id="NewModel-211"><a href="#NewModel-211"><span class="linenos">211</span></a>
</span><span id="NewModel-212"><a href="#NewModel-212"><span class="linenos">212</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-213"><a href="#NewModel-213"><span class="linenos">213</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-214"><a href="#NewModel-214"><span class="linenos">214</span></a><span class="sd">        context : dict</span>
</span><span id="NewModel-215"><a href="#NewModel-215"><span class="linenos">215</span></a><span class="sd">            A dictionary containing annotation results, including frame-based bounding boxes or points.</span>
</span><span id="NewModel-216"><a href="#NewModel-216"><span class="linenos">216</span></a><span class="sd">            The format is typically from Label Studio&#39;s `drafts` or `context`, with a &#39;result&#39; key.</span>
</span><span id="NewModel-217"><a href="#NewModel-217"><span class="linenos">217</span></a>
</span><span id="NewModel-218"><a href="#NewModel-218"><span class="linenos">218</span></a><span class="sd">        Returns</span>
</span><span id="NewModel-219"><a href="#NewModel-219"><span class="linenos">219</span></a><span class="sd">        -------</span>
</span><span id="NewModel-220"><a href="#NewModel-220"><span class="linenos">220</span></a><span class="sd">        List[Dict]</span>
</span><span id="NewModel-221"><a href="#NewModel-221"><span class="linenos">221</span></a><span class="sd">            A list of prompt dictionaries. Each contains:</span>
</span><span id="NewModel-222"><a href="#NewModel-222"><span class="linenos">222</span></a><span class="sd">            - &#39;points&#39;: np.ndarray of keypoints/box coords</span>
</span><span id="NewModel-223"><a href="#NewModel-223"><span class="linenos">223</span></a><span class="sd">            - &#39;labels&#39;: np.ndarray or None (for point prompts)</span>
</span><span id="NewModel-224"><a href="#NewModel-224"><span class="linenos">224</span></a><span class="sd">            - &#39;frame_idx&#39;: int zero-based frame index</span>
</span><span id="NewModel-225"><a href="#NewModel-225"><span class="linenos">225</span></a><span class="sd">            - &#39;obj_id&#39;: str object identifier</span>
</span><span id="NewModel-226"><a href="#NewModel-226"><span class="linenos">226</span></a>
</span><span id="NewModel-227"><a href="#NewModel-227"><span class="linenos">227</span></a><span class="sd">        Raises</span>
</span><span id="NewModel-228"><a href="#NewModel-228"><span class="linenos">228</span></a><span class="sd">        ------</span>
</span><span id="NewModel-229"><a href="#NewModel-229"><span class="linenos">229</span></a><span class="sd">        ValueError</span>
</span><span id="NewModel-230"><a href="#NewModel-230"><span class="linenos">230</span></a><span class="sd">            If PROMPT_TYPE is neither &#39;point&#39; nor &#39;box&#39;.</span>
</span><span id="NewModel-231"><a href="#NewModel-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-232"><a href="#NewModel-232"><span class="linenos">232</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting keypoints from context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-233"><a href="#NewModel-233"><span class="linenos">233</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NewModel-234"><a href="#NewModel-234"><span class="linenos">234</span></a>        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
</span><span id="NewModel-235"><a href="#NewModel-235"><span class="linenos">235</span></a>            <span class="c1"># Process each video tracking object separately</span>
</span><span id="NewModel-236"><a href="#NewModel-236"><span class="linenos">236</span></a>            <span class="n">obj_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="NewModel-237"><a href="#NewModel-237"><span class="linenos">237</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]:</span>
</span><span id="NewModel-238"><a href="#NewModel-238"><span class="linenos">238</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel-239"><a href="#NewModel-239"><span class="linenos">239</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel-240"><a href="#NewModel-240"><span class="linenos">240</span></a>                <span class="n">box_width</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel-241"><a href="#NewModel-241"><span class="linenos">241</span></a>                <span class="n">box_height</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel-242"><a href="#NewModel-242"><span class="linenos">242</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NewModel-243"><a href="#NewModel-243"><span class="linenos">243</span></a>
</span><span id="NewModel-244"><a href="#NewModel-244"><span class="linenos">244</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="NewModel-245"><a href="#NewModel-245"><span class="linenos">245</span></a>                    <span class="c1"># SAM2 video works with keypoints - convert the rectangle to the set of keypoints within the rectangle</span>
</span><span id="NewModel-246"><a href="#NewModel-246"><span class="linenos">246</span></a>                    <span class="c1"># bbox (x, y) is top-left corner</span>
</span><span id="NewModel-247"><a href="#NewModel-247"><span class="linenos">247</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NewModel-248"><a href="#NewModel-248"><span class="linenos">248</span></a>                        <span class="c1"># center of the bbox</span>
</span><span id="NewModel-249"><a href="#NewModel-249"><span class="linenos">249</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel-250"><a href="#NewModel-250"><span class="linenos">250</span></a>                        <span class="c1"># half of the bbox width to the left</span>
</span><span id="NewModel-251"><a href="#NewModel-251"><span class="linenos">251</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel-252"><a href="#NewModel-252"><span class="linenos">252</span></a>                        <span class="c1"># half of the bbox width to the right</span>
</span><span id="NewModel-253"><a href="#NewModel-253"><span class="linenos">253</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel-254"><a href="#NewModel-254"><span class="linenos">254</span></a>                        <span class="c1"># half of the bbox height to the top</span>
</span><span id="NewModel-255"><a href="#NewModel-255"><span class="linenos">255</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="NewModel-256"><a href="#NewModel-256"><span class="linenos">256</span></a>                        <span class="c1"># half of the bbox height to the bottom</span>
</span><span id="NewModel-257"><a href="#NewModel-257"><span class="linenos">257</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span>
</span><span id="NewModel-258"><a href="#NewModel-258"><span class="linenos">258</span></a>                    <span class="p">]</span>
</span><span id="NewModel-259"><a href="#NewModel-259"><span class="linenos">259</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="NewModel-260"><a href="#NewModel-260"><span class="linenos">260</span></a>                    <span class="c1"># SAM2 video works with boxes - use the rectangle inf xyxy format</span>
</span><span id="NewModel-261"><a href="#NewModel-261"><span class="linenos">261</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span><span class="p">]</span>
</span><span id="NewModel-262"><a href="#NewModel-262"><span class="linenos">262</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel-263"><a href="#NewModel-263"><span class="linenos">263</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid prompt type: </span><span class="si">{</span><span class="n">PROMPT_TYPE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-264"><a href="#NewModel-264"><span class="linenos">264</span></a>
</span><span id="NewModel-265"><a href="#NewModel-265"><span class="linenos">265</span></a>                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NewModel-266"><a href="#NewModel-266"><span class="linenos">266</span></a>                <span class="c1"># labels are not used for box prompts</span>
</span><span id="NewModel-267"><a href="#NewModel-267"><span class="linenos">267</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NewModel-268"><a href="#NewModel-268"><span class="linenos">268</span></a>                <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel-269"><a href="#NewModel-269"><span class="linenos">269</span></a>                    <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
</span><span id="NewModel-270"><a href="#NewModel-270"><span class="linenos">270</span></a>                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
</span><span id="NewModel-271"><a href="#NewModel-271"><span class="linenos">271</span></a>                    <span class="s1">&#39;frame_idx&#39;</span><span class="p">:</span> <span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel-272"><a href="#NewModel-272"><span class="linenos">272</span></a>                    <span class="s1">&#39;obj_id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="NewModel-273"><a href="#NewModel-273"><span class="linenos">273</span></a>                <span class="p">})</span>
</span><span id="NewModel-274"><a href="#NewModel-274"><span class="linenos">274</span></a>
</span><span id="NewModel-275"><a href="#NewModel-275"><span class="linenos">275</span></a>        <span class="k">return</span> <span class="n">prompts</span>
</span><span id="NewModel-276"><a href="#NewModel-276"><span class="linenos">276</span></a>
</span><span id="NewModel-277"><a href="#NewModel-277"><span class="linenos">277</span></a>    <span class="k">def</span> <span class="nf">_get_fps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span id="NewModel-278"><a href="#NewModel-278"><span class="linenos">278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-279"><a href="#NewModel-279"><span class="linenos">279</span></a><span class="sd">        Extract frames per second (FPS) and duration from the context.</span>
</span><span id="NewModel-280"><a href="#NewModel-280"><span class="linenos">280</span></a>
</span><span id="NewModel-281"><a href="#NewModel-281"><span class="linenos">281</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-282"><a href="#NewModel-282"><span class="linenos">282</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-283"><a href="#NewModel-283"><span class="linenos">283</span></a><span class="sd">        context : dict</span>
</span><span id="NewModel-284"><a href="#NewModel-284"><span class="linenos">284</span></a><span class="sd">            Annotation context containing &#39;framesCount&#39; and &#39;duration&#39;.</span>
</span><span id="NewModel-285"><a href="#NewModel-285"><span class="linenos">285</span></a>
</span><span id="NewModel-286"><a href="#NewModel-286"><span class="linenos">286</span></a><span class="sd">        Returns</span>
</span><span id="NewModel-287"><a href="#NewModel-287"><span class="linenos">287</span></a><span class="sd">        -------</span>
</span><span id="NewModel-288"><a href="#NewModel-288"><span class="linenos">288</span></a><span class="sd">        tuple of (int, float)</span>
</span><span id="NewModel-289"><a href="#NewModel-289"><span class="linenos">289</span></a><span class="sd">            frames_count, duration</span>
</span><span id="NewModel-290"><a href="#NewModel-290"><span class="linenos">290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-291"><a href="#NewModel-291"><span class="linenos">291</span></a>        <span class="c1"># get the fps from the context</span>
</span><span id="NewModel-292"><a href="#NewModel-292"><span class="linenos">292</span></a>        <span class="n">frames_count</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;framesCount&#39;</span><span class="p">]</span>
</span><span id="NewModel-293"><a href="#NewModel-293"><span class="linenos">293</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
</span><span id="NewModel-294"><a href="#NewModel-294"><span class="linenos">294</span></a>        <span class="k">return</span> <span class="n">frames_count</span><span class="p">,</span> <span class="n">duration</span>
</span><span id="NewModel-295"><a href="#NewModel-295"><span class="linenos">295</span></a>
</span><span id="NewModel-296"><a href="#NewModel-296"><span class="linenos">296</span></a>    <span class="c1"># def convert_mask_to_bbox(self, mask):</span>
</span><span id="NewModel-297"><a href="#NewModel-297"><span class="linenos">297</span></a>    <span class="c1">#     # convert mask to bbox</span>
</span><span id="NewModel-298"><a href="#NewModel-298"><span class="linenos">298</span></a>    <span class="c1">#     h, w = mask.shape[-2:]</span>
</span><span id="NewModel-299"><a href="#NewModel-299"><span class="linenos">299</span></a>    <span class="c1">#     mask_int = mask.reshape(h, w, 1).astype(np.uint8)</span>
</span><span id="NewModel-300"><a href="#NewModel-300"><span class="linenos">300</span></a>    <span class="c1">#     contours, _ = cv2.findContours(mask_int, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</span>
</span><span id="NewModel-301"><a href="#NewModel-301"><span class="linenos">301</span></a>    <span class="c1">#     if len(contours) == 0:</span>
</span><span id="NewModel-302"><a href="#NewModel-302"><span class="linenos">302</span></a>    <span class="c1">#         return None</span>
</span><span id="NewModel-303"><a href="#NewModel-303"><span class="linenos">303</span></a>    <span class="c1">#     x, y, w, h = cv2.boundingRect(contours[0])</span>
</span><span id="NewModel-304"><a href="#NewModel-304"><span class="linenos">304</span></a>    <span class="c1">#     return {</span>
</span><span id="NewModel-305"><a href="#NewModel-305"><span class="linenos">305</span></a>    <span class="c1">#         &#39;x&#39;: x,</span>
</span><span id="NewModel-306"><a href="#NewModel-306"><span class="linenos">306</span></a>    <span class="c1">#         &#39;y&#39;: y,</span>
</span><span id="NewModel-307"><a href="#NewModel-307"><span class="linenos">307</span></a>    <span class="c1">#         &#39;width&#39;: w,</span>
</span><span id="NewModel-308"><a href="#NewModel-308"><span class="linenos">308</span></a>    <span class="c1">#         &#39;height&#39;: h</span>
</span><span id="NewModel-309"><a href="#NewModel-309"><span class="linenos">309</span></a>    <span class="c1">#     }</span>
</span><span id="NewModel-310"><a href="#NewModel-310"><span class="linenos">310</span></a>
</span><span id="NewModel-311"><a href="#NewModel-311"><span class="linenos">311</span></a>    <span class="k">def</span> <span class="nf">convert_mask_to_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="NewModel-312"><a href="#NewModel-312"><span class="linenos">312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-313"><a href="#NewModel-313"><span class="linenos">313</span></a><span class="sd">        Convert a binary mask to a bounding box in normalized percentages.</span>
</span><span id="NewModel-314"><a href="#NewModel-314"><span class="linenos">314</span></a>
</span><span id="NewModel-315"><a href="#NewModel-315"><span class="linenos">315</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-316"><a href="#NewModel-316"><span class="linenos">316</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-317"><a href="#NewModel-317"><span class="linenos">317</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="NewModel-318"><a href="#NewModel-318"><span class="linenos">318</span></a><span class="sd">            A binary mask of shape (H, W) where 1 indicates object pixels.</span>
</span><span id="NewModel-319"><a href="#NewModel-319"><span class="linenos">319</span></a>
</span><span id="NewModel-320"><a href="#NewModel-320"><span class="linenos">320</span></a><span class="sd">        Returns</span>
</span><span id="NewModel-321"><a href="#NewModel-321"><span class="linenos">321</span></a><span class="sd">        -------</span>
</span><span id="NewModel-322"><a href="#NewModel-322"><span class="linenos">322</span></a><span class="sd">        dict or None</span>
</span><span id="NewModel-323"><a href="#NewModel-323"><span class="linenos">323</span></a><span class="sd">            A dictionary with keys &#39;x&#39;, &#39;y&#39;, &#39;width&#39;, &#39;height&#39; representing the bounding box in percentage,</span>
</span><span id="NewModel-324"><a href="#NewModel-324"><span class="linenos">324</span></a><span class="sd">            or None if no object pixels are found.</span>
</span><span id="NewModel-325"><a href="#NewModel-325"><span class="linenos">325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-326"><a href="#NewModel-326"><span class="linenos">326</span></a>        <span class="c1"># squeeze</span>
</span><span id="NewModel-327"><a href="#NewModel-327"><span class="linenos">327</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="NewModel-328"><a href="#NewModel-328"><span class="linenos">328</span></a>
</span><span id="NewModel-329"><a href="#NewModel-329"><span class="linenos">329</span></a>        <span class="n">y_indices</span><span class="p">,</span> <span class="n">x_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NewModel-330"><a href="#NewModel-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NewModel-331"><a href="#NewModel-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NewModel-332"><a href="#NewModel-332"><span class="linenos">332</span></a>
</span><span id="NewModel-333"><a href="#NewModel-333"><span class="linenos">333</span></a>        <span class="c1"># Find the min and max indices</span>
</span><span id="NewModel-334"><a href="#NewModel-334"><span class="linenos">334</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span>
</span><span id="NewModel-335"><a href="#NewModel-335"><span class="linenos">335</span></a>        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span>
</span><span id="NewModel-336"><a href="#NewModel-336"><span class="linenos">336</span></a>
</span><span id="NewModel-337"><a href="#NewModel-337"><span class="linenos">337</span></a>        <span class="c1"># Get mask dimensions</span>
</span><span id="NewModel-338"><a href="#NewModel-338"><span class="linenos">338</span></a>        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NewModel-339"><a href="#NewModel-339"><span class="linenos">339</span></a>
</span><span id="NewModel-340"><a href="#NewModel-340"><span class="linenos">340</span></a>        <span class="c1"># Calculate bounding box dimensions</span>
</span><span id="NewModel-341"><a href="#NewModel-341"><span class="linenos">341</span></a>        <span class="n">box_width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="NewModel-342"><a href="#NewModel-342"><span class="linenos">342</span></a>        <span class="n">box_height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="NewModel-343"><a href="#NewModel-343"><span class="linenos">343</span></a>
</span><span id="NewModel-344"><a href="#NewModel-344"><span class="linenos">344</span></a>        <span class="c1"># Normalize and scale to percentage</span>
</span><span id="NewModel-345"><a href="#NewModel-345"><span class="linenos">345</span></a>        <span class="n">x_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel-346"><a href="#NewModel-346"><span class="linenos">346</span></a>        <span class="n">y_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel-347"><a href="#NewModel-347"><span class="linenos">347</span></a>        <span class="n">width_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel-348"><a href="#NewModel-348"><span class="linenos">348</span></a>        <span class="n">height_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_height</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel-349"><a href="#NewModel-349"><span class="linenos">349</span></a>
</span><span id="NewModel-350"><a href="#NewModel-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="NewModel-351"><a href="#NewModel-351"><span class="linenos">351</span></a>            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel-352"><a href="#NewModel-352"><span class="linenos">352</span></a>            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel-353"><a href="#NewModel-353"><span class="linenos">353</span></a>            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">width_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel-354"><a href="#NewModel-354"><span class="linenos">354</span></a>            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">height_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NewModel-355"><a href="#NewModel-355"><span class="linenos">355</span></a>        <span class="p">}</span>
</span><span id="NewModel-356"><a href="#NewModel-356"><span class="linenos">356</span></a>
</span><span id="NewModel-357"><a href="#NewModel-357"><span class="linenos">357</span></a>
</span><span id="NewModel-358"><a href="#NewModel-358"><span class="linenos">358</span></a>    <span class="k">def</span> <span class="nf">dump_image_with_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NewModel-359"><a href="#NewModel-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-360"><a href="#NewModel-360"><span class="linenos">360</span></a><span class="sd">        Debug utility to overlay a mask onto a frame and save it as an image file.</span>
</span><span id="NewModel-361"><a href="#NewModel-361"><span class="linenos">361</span></a>
</span><span id="NewModel-362"><a href="#NewModel-362"><span class="linenos">362</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-363"><a href="#NewModel-363"><span class="linenos">363</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-364"><a href="#NewModel-364"><span class="linenos">364</span></a><span class="sd">        frame : np.ndarray</span>
</span><span id="NewModel-365"><a href="#NewModel-365"><span class="linenos">365</span></a><span class="sd">            The original frame image (H, W, C).</span>
</span><span id="NewModel-366"><a href="#NewModel-366"><span class="linenos">366</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="NewModel-367"><a href="#NewModel-367"><span class="linenos">367</span></a><span class="sd">            A binary mask for the object (H, W).</span>
</span><span id="NewModel-368"><a href="#NewModel-368"><span class="linenos">368</span></a><span class="sd">        output_file : str</span>
</span><span id="NewModel-369"><a href="#NewModel-369"><span class="linenos">369</span></a><span class="sd">            Path to save the output image.</span>
</span><span id="NewModel-370"><a href="#NewModel-370"><span class="linenos">370</span></a><span class="sd">        obj_id : int, optional</span>
</span><span id="NewModel-371"><a href="#NewModel-371"><span class="linenos">371</span></a><span class="sd">            Object identifier to pick a color from a colormap.</span>
</span><span id="NewModel-372"><a href="#NewModel-372"><span class="linenos">372</span></a><span class="sd">        random_color : bool, optional</span>
</span><span id="NewModel-373"><a href="#NewModel-373"><span class="linenos">373</span></a><span class="sd">            If True, use a random color for the mask overlay.</span>
</span><span id="NewModel-374"><a href="#NewModel-374"><span class="linenos">374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-375"><a href="#NewModel-375"><span class="linenos">375</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="NewModel-376"><a href="#NewModel-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="n">random_color</span><span class="p">:</span>
</span><span id="NewModel-377"><a href="#NewModel-377"><span class="linenos">377</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.6</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NewModel-378"><a href="#NewModel-378"><span class="linenos">378</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel-379"><a href="#NewModel-379"><span class="linenos">379</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>
</span><span id="NewModel-380"><a href="#NewModel-380"><span class="linenos">380</span></a>            <span class="n">cmap_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">obj_id</span>
</span><span id="NewModel-381"><a href="#NewModel-381"><span class="linenos">381</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">cmap_idx</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">])</span>
</span><span id="NewModel-382"><a href="#NewModel-382"><span class="linenos">382</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="NewModel-383"><a href="#NewModel-383"><span class="linenos">383</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NewModel-384"><a href="#NewModel-384"><span class="linenos">384</span></a>
</span><span id="NewModel-385"><a href="#NewModel-385"><span class="linenos">385</span></a>        <span class="c1"># create an image file to display image overlayed with mask</span>
</span><span id="NewModel-386"><a href="#NewModel-386"><span class="linenos">386</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NewModel-387"><a href="#NewModel-387"><span class="linenos">387</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGRA2BGR</span><span class="p">)</span>
</span><span id="NewModel-388"><a href="#NewModel-388"><span class="linenos">388</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NewModel-389"><a href="#NewModel-389"><span class="linenos">389</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapes: frame=</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask_image=</span><span class="si">{</span><span class="n">mask_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-390"><a href="#NewModel-390"><span class="linenos">390</span></a>        <span class="c1"># save in file</span>
</span><span id="NewModel-391"><a href="#NewModel-391"><span class="linenos">391</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving image with mask to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-392"><a href="#NewModel-392"><span class="linenos">392</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">)</span>
</span><span id="NewModel-393"><a href="#NewModel-393"><span class="linenos">393</span></a>
</span><span id="NewModel-394"><a href="#NewModel-394"><span class="linenos">394</span></a>
</span><span id="NewModel-395"><a href="#NewModel-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelResponse</span><span class="p">:</span>
</span><span id="NewModel-396"><a href="#NewModel-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel-397"><a href="#NewModel-397"><span class="linenos">397</span></a><span class="sd">        Run the prediction to generate segmentation masks for a given set of video frames.</span>
</span><span id="NewModel-398"><a href="#NewModel-398"><span class="linenos">398</span></a>
</span><span id="NewModel-399"><a href="#NewModel-399"><span class="linenos">399</span></a><span class="sd">        The model:</span>
</span><span id="NewModel-400"><a href="#NewModel-400"><span class="linenos">400</span></a><span class="sd">        1. Extracts prompts (boxes/points) from the given tasks and drafts.</span>
</span><span id="NewModel-401"><a href="#NewModel-401"><span class="linenos">401</span></a><span class="sd">        2. Uses the SAM2 predictor to track the object(s) through frames.</span>
</span><span id="NewModel-402"><a href="#NewModel-402"><span class="linenos">402</span></a><span class="sd">        3. Updates annotations in Label Studio with the new masks and bounding boxes.</span>
</span><span id="NewModel-403"><a href="#NewModel-403"><span class="linenos">403</span></a>
</span><span id="NewModel-404"><a href="#NewModel-404"><span class="linenos">404</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel-405"><a href="#NewModel-405"><span class="linenos">405</span></a><span class="sd">        ----------</span>
</span><span id="NewModel-406"><a href="#NewModel-406"><span class="linenos">406</span></a><span class="sd">        tasks : list of dict</span>
</span><span id="NewModel-407"><a href="#NewModel-407"><span class="linenos">407</span></a><span class="sd">            List of tasks to be annotated, each containing video data and drafts or annotations.</span>
</span><span id="NewModel-408"><a href="#NewModel-408"><span class="linenos">408</span></a><span class="sd">        context : dict, optional</span>
</span><span id="NewModel-409"><a href="#NewModel-409"><span class="linenos">409</span></a><span class="sd">            Additional context with annotation results. If no drafts are found, context is used as a fallback.</span>
</span><span id="NewModel-410"><a href="#NewModel-410"><span class="linenos">410</span></a><span class="sd">        **kwargs</span>
</span><span id="NewModel-411"><a href="#NewModel-411"><span class="linenos">411</span></a><span class="sd">            Additional keyword arguments (unused).</span>
</span><span id="NewModel-412"><a href="#NewModel-412"><span class="linenos">412</span></a>
</span><span id="NewModel-413"><a href="#NewModel-413"><span class="linenos">413</span></a><span class="sd">        Returns</span>
</span><span id="NewModel-414"><a href="#NewModel-414"><span class="linenos">414</span></a><span class="sd">        -------</span>
</span><span id="NewModel-415"><a href="#NewModel-415"><span class="linenos">415</span></a><span class="sd">        ModelResponse</span>
</span><span id="NewModel-416"><a href="#NewModel-416"><span class="linenos">416</span></a><span class="sd">            A structured response containing updated annotations for Label Studio.</span>
</span><span id="NewModel-417"><a href="#NewModel-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel-418"><a href="#NewModel-418"><span class="linenos">418</span></a>        <span class="n">from_name</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_tag_occurence</span><span class="p">(</span><span class="s1">&#39;VideoRectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;Video&#39;</span><span class="p">)</span>
</span><span id="NewModel-419"><a href="#NewModel-419"><span class="linenos">419</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NewModel-420"><a href="#NewModel-420"><span class="linenos">420</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;drafts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel-421"><a href="#NewModel-421"><span class="linenos">421</span></a>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="NewModel-422"><a href="#NewModel-422"><span class="linenos">422</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Drafts not found, using annotations&#39;</span><span class="p">)</span>
</span><span id="NewModel-423"><a href="#NewModel-423"><span class="linenos">423</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="NewModel-424"><a href="#NewModel-424"><span class="linenos">424</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel-425"><a href="#NewModel-425"><span class="linenos">425</span></a>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="NewModel-426"><a href="#NewModel-426"><span class="linenos">426</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Annotations not found, using context&#39;</span><span class="p">)</span>
</span><span id="NewModel-427"><a href="#NewModel-427"><span class="linenos">427</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NewModel-428"><a href="#NewModel-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">drafts</span><span class="p">):</span>
</span><span id="NewModel-429"><a href="#NewModel-429"><span class="linenos">429</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Draft empty, using context&#39;</span><span class="p">)</span>
</span><span id="NewModel-430"><a href="#NewModel-430"><span class="linenos">430</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NewModel-431"><a href="#NewModel-431"><span class="linenos">431</span></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel-432"><a href="#NewModel-432"><span class="linenos">432</span></a>        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="NewModel-433"><a href="#NewModel-433"><span class="linenos">433</span></a>        <span class="c1"># Get the video URL from the task</span>
</span><span id="NewModel-434"><a href="#NewModel-434"><span class="linenos">434</span></a>        <span class="n">video_url</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span>
</span><span id="NewModel-435"><a href="#NewModel-435"><span class="linenos">435</span></a>
</span><span id="NewModel-436"><a href="#NewModel-436"><span class="linenos">436</span></a>        <span class="c1"># cache the video locally</span>
</span><span id="NewModel-437"><a href="#NewModel-437"><span class="linenos">437</span></a>        <span class="n">video_path</span> <span class="o">=</span> <span class="n">get_local_path</span><span class="p">(</span><span class="n">video_url</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">)</span>
</span><span id="NewModel-438"><a href="#NewModel-438"><span class="linenos">438</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video path: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-439"><a href="#NewModel-439"><span class="linenos">439</span></a>
</span><span id="NewModel-440"><a href="#NewModel-440"><span class="linenos">440</span></a>        <span class="c1"># get prompts from context</span>
</span><span id="NewModel-441"><a href="#NewModel-441"><span class="linenos">441</span></a>        <span class="c1"># prompts = self.get_prompts(context)</span>
</span><span id="NewModel-442"><a href="#NewModel-442"><span class="linenos">442</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prompts</span><span class="p">(</span><span class="n">drafts</span><span class="p">)</span>
</span><span id="NewModel-443"><a href="#NewModel-443"><span class="linenos">443</span></a>
</span><span id="NewModel-444"><a href="#NewModel-444"><span class="linenos">444</span></a>        <span class="n">context_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]])</span>
</span><span id="NewModel-445"><a href="#NewModel-445"><span class="linenos">445</span></a>        <span class="n">all_obj_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="o">+</span>
</span><span id="NewModel-446"><a href="#NewModel-446"><span class="linenos">446</span></a>                          <span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="p">[]))</span>
</span><span id="NewModel-447"><a href="#NewModel-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">context_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span> <span class="n">all_obj_ids</span><span class="p">):</span>
</span><span id="NewModel-448"><a href="#NewModel-448"><span class="linenos">448</span></a>            <span class="c1"># Returning here because the case where object ids in the context do not match the ids found in the annotations is not supported.</span>
</span><span id="NewModel-449"><a href="#NewModel-449"><span class="linenos">449</span></a>            <span class="c1"># This remains an open issue but is not considered a substantial problem.</span>
</span><span id="NewModel-450"><a href="#NewModel-450"><span class="linenos">450</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Context id </span><span class="si">{</span><span class="n">context_ids</span><span class="si">}</span><span class="s1"> not found in drafts result: </span><span class="si">{</span><span class="n">all_obj_ids</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="NewModel-451"><a href="#NewModel-451"><span class="linenos">451</span></a>                                      <span class="sa">f</span><span class="s1">&#39;TODO merge context and drafts&#39;</span><span class="p">)</span>
</span><span id="NewModel-452"><a href="#NewModel-452"><span class="linenos">452</span></a>
</span><span id="NewModel-453"><a href="#NewModel-453"><span class="linenos">453</span></a>        <span class="c1"># create a map from obj_id to integer</span>
</span><span id="NewModel-454"><a href="#NewModel-454"><span class="linenos">454</span></a>        <span class="n">obj_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)}</span>
</span><span id="NewModel-455"><a href="#NewModel-455"><span class="linenos">455</span></a>        <span class="c1"># find the last frame index</span>
</span><span id="NewModel-456"><a href="#NewModel-456"><span class="linenos">456</span></a>        <span class="c1"># if there is only one object, use the last frame of the object: continue tracking from last tracked frame</span>
</span><span id="NewModel-457"><a href="#NewModel-457"><span class="linenos">457</span></a>        <span class="c1"># if there are multiple objects, use the smallest frame index of all objects</span>
</span><span id="NewModel-458"><a href="#NewModel-458"><span class="linenos">458</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="NewModel-459"><a href="#NewModel-459"><span class="linenos">459</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel-460"><a href="#NewModel-460"><span class="linenos">460</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel-461"><a href="#NewModel-461"><span class="linenos">461</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel-462"><a href="#NewModel-462"><span class="linenos">462</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel-463"><a href="#NewModel-463"><span class="linenos">463</span></a>            <span class="c1"># the minimum of the maximum frame_idx of all objects grouped by id</span>
</span><span id="NewModel-464"><a href="#NewModel-464"><span class="linenos">464</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">)</span>
</span><span id="NewModel-465"><a href="#NewModel-465"><span class="linenos">465</span></a>        <span class="n">frames_count</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="NewModel-466"><a href="#NewModel-466"><span class="linenos">466</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">frames_count</span> <span class="o">/</span> <span class="n">duration</span>
</span><span id="NewModel-467"><a href="#NewModel-467"><span class="linenos">467</span></a>
</span><span id="NewModel-468"><a href="#NewModel-468"><span class="linenos">468</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="NewModel-469"><a href="#NewModel-469"><span class="linenos">469</span></a>            <span class="sa">f</span><span class="s1">&#39;Number of prompts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel-470"><a href="#NewModel-470"><span class="linenos">470</span></a>            <span class="sa">f</span><span class="s1">&#39;first frame index: </span><span class="si">{</span><span class="n">first_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel-471"><a href="#NewModel-471"><span class="linenos">471</span></a>            <span class="sa">f</span><span class="s1">&#39;last frame index: </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel-472"><a href="#NewModel-472"><span class="linenos">472</span></a>            <span class="sa">f</span><span class="s1">&#39;obj_ids: </span><span class="si">{</span><span class="n">obj_ids</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-473"><a href="#NewModel-473"><span class="linenos">473</span></a>
</span><span id="NewModel-474"><a href="#NewModel-474"><span class="linenos">474</span></a>        <span class="n">frames_to_track</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_FRAMES_TO_TRACK</span><span class="p">,</span> <span class="n">frames_count</span> <span class="o">-</span> <span class="n">last_frame_idx</span><span class="p">)</span>
</span><span id="NewModel-475"><a href="#NewModel-475"><span class="linenos">475</span></a>
</span><span id="NewModel-476"><a href="#NewModel-476"><span class="linenos">476</span></a>        <span class="c1"># Split the video into frames</span>
</span><span id="NewModel-477"><a href="#NewModel-477"><span class="linenos">477</span></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
</span><span id="NewModel-478"><a href="#NewModel-478"><span class="linenos">478</span></a>
</span><span id="NewModel-479"><a href="#NewModel-479"><span class="linenos">479</span></a>            <span class="c1"># # use persisted dir for debug</span>
</span><span id="NewModel-480"><a href="#NewModel-480"><span class="linenos">480</span></a>            <span class="c1"># temp_dir = &#39;/tmp/frames&#39;</span>
</span><span id="NewModel-481"><a href="#NewModel-481"><span class="linenos">481</span></a>            <span class="c1"># os.makedirs(temp_dir, exist_ok=True)</span>
</span><span id="NewModel-482"><a href="#NewModel-482"><span class="linenos">482</span></a>
</span><span id="NewModel-483"><a href="#NewModel-483"><span class="linenos">483</span></a>            <span class="c1"># get all frames</span>
</span><span id="NewModel-484"><a href="#NewModel-484"><span class="linenos">484</span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_frames</span><span class="p">(</span>
</span><span id="NewModel-485"><a href="#NewModel-485"><span class="linenos">485</span></a>                <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span>
</span><span id="NewModel-486"><a href="#NewModel-486"><span class="linenos">486</span></a>                <span class="n">start_frame</span><span class="o">=</span><span class="n">first_frame_idx</span><span class="p">,</span>
</span><span id="NewModel-487"><a href="#NewModel-487"><span class="linenos">487</span></a>                <span class="n">end_frame</span><span class="o">=</span><span class="n">last_frame_idx</span> <span class="o">+</span> <span class="n">frames_to_track</span>
</span><span id="NewModel-488"><a href="#NewModel-488"><span class="linenos">488</span></a>            <span class="p">))</span>
</span><span id="NewModel-489"><a href="#NewModel-489"><span class="linenos">489</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NewModel-490"><a href="#NewModel-490"><span class="linenos">490</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video width=</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">, height=</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-491"><a href="#NewModel-491"><span class="linenos">491</span></a>
</span><span id="NewModel-492"><a href="#NewModel-492"><span class="linenos">492</span></a>            <span class="c1"># get inference state</span>
</span><span id="NewModel-493"><a href="#NewModel-493"><span class="linenos">493</span></a>            <span class="n">inference_state</span> <span class="o">=</span> <span class="n">get_inference_state</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</span><span id="NewModel-494"><a href="#NewModel-494"><span class="linenos">494</span></a>            <span class="n">predictor</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span><span class="n">inference_state</span><span class="p">)</span>
</span><span id="NewModel-495"><a href="#NewModel-495"><span class="linenos">495</span></a>
</span><span id="NewModel-496"><a href="#NewModel-496"><span class="linenos">496</span></a>            <span class="c1"># Group prompts by &#39;obj_id&#39; and sort them by &#39;frame_idx&#39; in one step</span>
</span><span id="NewModel-497"><a href="#NewModel-497"><span class="linenos">497</span></a>            <span class="n">prompt_id_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="NewModel-498"><a href="#NewModel-498"><span class="linenos">498</span></a>            <span class="p">[</span><span class="n">prompt_id_dict</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="NewModel-499"><a href="#NewModel-499"><span class="linenos">499</span></a>
</span><span id="NewModel-500"><a href="#NewModel-500"><span class="linenos">500</span></a>            <span class="c1"># Sort the prompts and extract the highest frame index for each object ID</span>
</span><span id="NewModel-501"><a href="#NewModel-501"><span class="linenos">501</span></a>            <span class="n">highest_frames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prompts</span> <span class="ow">in</span>
</span><span id="NewModel-502"><a href="#NewModel-502"><span class="linenos">502</span></a>                              <span class="n">prompt_id_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="NewModel-503"><a href="#NewModel-503"><span class="linenos">503</span></a>
</span><span id="NewModel-504"><a href="#NewModel-504"><span class="linenos">504</span></a>            <span class="c1"># Get the minimum value of the highest frame indices</span>
</span><span id="NewModel-505"><a href="#NewModel-505"><span class="linenos">505</span></a>            <span class="n">prompt_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">highest_frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">highest_frames</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NewModel-506"><a href="#NewModel-506"><span class="linenos">506</span></a>
</span><span id="NewModel-507"><a href="#NewModel-507"><span class="linenos">507</span></a>            <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
</span><span id="NewModel-508"><a href="#NewModel-508"><span class="linenos">508</span></a>
</span><span id="NewModel-509"><a href="#NewModel-509"><span class="linenos">509</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_frame_idx</span>
</span><span id="NewModel-510"><a href="#NewModel-510"><span class="linenos">510</span></a>                <span class="c1"># sam 2 not predict other frame if are present prompts after the frame: the prompt must be set in the same frame for each object</span>
</span><span id="NewModel-511"><a href="#NewModel-511"><span class="linenos">511</span></a>                <span class="k">if</span> <span class="n">frame_idx</span> <span class="o">&gt;</span> <span class="n">prompt_idx</span><span class="p">:</span>
</span><span id="NewModel-512"><a href="#NewModel-512"><span class="linenos">512</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prompt frame index </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s1"> is out of bounds&#39;</span><span class="p">)</span>
</span><span id="NewModel-513"><a href="#NewModel-513"><span class="linenos">513</span></a>                    <span class="k">continue</span>
</span><span id="NewModel-514"><a href="#NewModel-514"><span class="linenos">514</span></a>
</span><span id="NewModel-515"><a href="#NewModel-515"><span class="linenos">515</span></a>
</span><span id="NewModel-516"><a href="#NewModel-516"><span class="linenos">516</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="NewModel-517"><a href="#NewModel-517"><span class="linenos">517</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="NewModel-518"><a href="#NewModel-518"><span class="linenos">518</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel-519"><a href="#NewModel-519"><span class="linenos">519</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel-520"><a href="#NewModel-520"><span class="linenos">520</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="NewModel-521"><a href="#NewModel-521"><span class="linenos">521</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel-522"><a href="#NewModel-522"><span class="linenos">522</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel-523"><a href="#NewModel-523"><span class="linenos">523</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="NewModel-524"><a href="#NewModel-524"><span class="linenos">524</span></a>                        <span class="n">points</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="NewModel-525"><a href="#NewModel-525"><span class="linenos">525</span></a>                        <span class="n">labels</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</span><span id="NewModel-526"><a href="#NewModel-526"><span class="linenos">526</span></a>                    <span class="p">)</span>
</span><span id="NewModel-527"><a href="#NewModel-527"><span class="linenos">527</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="NewModel-528"><a href="#NewModel-528"><span class="linenos">528</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="NewModel-529"><a href="#NewModel-529"><span class="linenos">529</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel-530"><a href="#NewModel-530"><span class="linenos">530</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel-531"><a href="#NewModel-531"><span class="linenos">531</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel-532"><a href="#NewModel-532"><span class="linenos">532</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel-533"><a href="#NewModel-533"><span class="linenos">533</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="NewModel-534"><a href="#NewModel-534"><span class="linenos">534</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel-535"><a href="#NewModel-535"><span class="linenos">535</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel-536"><a href="#NewModel-536"><span class="linenos">536</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="NewModel-537"><a href="#NewModel-537"><span class="linenos">537</span></a>                        <span class="n">box</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="NewModel-538"><a href="#NewModel-538"><span class="linenos">538</span></a>                    <span class="p">)</span>
</span><span id="NewModel-539"><a href="#NewModel-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel-540"><a href="#NewModel-540"><span class="linenos">540</span></a>              <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;./debug-frames&#39;</span>
</span><span id="NewModel-541"><a href="#NewModel-541"><span class="linenos">541</span></a>              <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NewModel-542"><a href="#NewModel-542"><span class="linenos">542</span></a>
</span><span id="NewModel-543"><a href="#NewModel-543"><span class="linenos">543</span></a>            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="NewModel-544"><a href="#NewModel-544"><span class="linenos">544</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Propagating in video from frame </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">frames_to_track</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-545"><a href="#NewModel-545"><span class="linenos">545</span></a>            <span class="k">for</span> <span class="n">out_frame_idx</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="ow">in</span> <span class="n">predictor</span><span class="o">.</span><span class="n">propagate_in_video</span><span class="p">(</span>
</span><span id="NewModel-546"><a href="#NewModel-546"><span class="linenos">546</span></a>                <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel-547"><a href="#NewModel-547"><span class="linenos">547</span></a>                <span class="n">start_frame_idx</span><span class="o">=</span><span class="n">last_frame_idx</span><span class="p">,</span>
</span><span id="NewModel-548"><a href="#NewModel-548"><span class="linenos">548</span></a>                <span class="n">max_frame_num_to_track</span><span class="o">=</span><span class="n">frames_to_track</span>
</span><span id="NewModel-549"><a href="#NewModel-549"><span class="linenos">549</span></a>            <span class="p">):</span>
</span><span id="NewModel-550"><a href="#NewModel-550"><span class="linenos">550</span></a>                <span class="n">real_frame_idx</span> <span class="o">=</span> <span class="n">out_frame_idx</span> <span class="o">+</span> <span class="n">first_frame_idx</span>
</span><span id="NewModel-551"><a href="#NewModel-551"><span class="linenos">551</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out_obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_obj_ids</span><span class="p">):</span>
</span><span id="NewModel-552"><a href="#NewModel-552"><span class="linenos">552</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_mask_logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="NewModel-553"><a href="#NewModel-553"><span class="linenos">553</span></a>
</span><span id="NewModel-554"><a href="#NewModel-554"><span class="linenos">554</span></a>                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel-555"><a href="#NewModel-555"><span class="linenos">555</span></a>
</span><span id="NewModel-556"><a href="#NewModel-556"><span class="linenos">556</span></a>                      <span class="c1"># to debug, save the mask as an image</span>
</span><span id="NewModel-557"><a href="#NewModel-557"><span class="linenos">557</span></a>                      <span class="bp">self</span><span class="o">.</span><span class="n">dump_image_with_mask</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">out_frame_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">debug_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">out_frame_idx</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">out_obj_id</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">out_obj_id</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NewModel-558"><a href="#NewModel-558"><span class="linenos">558</span></a>
</span><span id="NewModel-559"><a href="#NewModel-559"><span class="linenos">559</span></a>                    <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_mask_to_bbox</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="NewModel-560"><a href="#NewModel-560"><span class="linenos">560</span></a>                    <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
</span><span id="NewModel-561"><a href="#NewModel-561"><span class="linenos">561</span></a>                        <span class="n">obj_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">out_obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="NewModel-562"><a href="#NewModel-562"><span class="linenos">562</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="NewModel-563"><a href="#NewModel-563"><span class="linenos">563</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel-564"><a href="#NewModel-564"><span class="linenos">564</span></a>                            <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">real_frame_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="NewModel-565"><a href="#NewModel-565"><span class="linenos">565</span></a>                            <span class="c1"># &#39;x&#39;: bbox[&#39;x&#39;] / width * 100,</span>
</span><span id="NewModel-566"><a href="#NewModel-566"><span class="linenos">566</span></a>                            <span class="c1"># &#39;y&#39;: bbox[&#39;y&#39;] / height * 100,</span>
</span><span id="NewModel-567"><a href="#NewModel-567"><span class="linenos">567</span></a>                            <span class="c1"># &#39;width&#39;: bbox[&#39;width&#39;] / width * 100,</span>
</span><span id="NewModel-568"><a href="#NewModel-568"><span class="linenos">568</span></a>                            <span class="c1"># &#39;height&#39;: bbox[&#39;height&#39;] / height * 100,</span>
</span><span id="NewModel-569"><a href="#NewModel-569"><span class="linenos">569</span></a>                            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
</span><span id="NewModel-570"><a href="#NewModel-570"><span class="linenos">570</span></a>                            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
</span><span id="NewModel-571"><a href="#NewModel-571"><span class="linenos">571</span></a>                            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
</span><span id="NewModel-572"><a href="#NewModel-572"><span class="linenos">572</span></a>                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
</span><span id="NewModel-573"><a href="#NewModel-573"><span class="linenos">573</span></a>                            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="NewModel-574"><a href="#NewModel-574"><span class="linenos">574</span></a>                            <span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="NewModel-575"><a href="#NewModel-575"><span class="linenos">575</span></a>                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">out_frame_idx</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="NewModel-576"><a href="#NewModel-576"><span class="linenos">576</span></a>                        <span class="p">})</span>
</span><span id="NewModel-577"><a href="#NewModel-577"><span class="linenos">577</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NewModel-578"><a href="#NewModel-578"><span class="linenos">578</span></a>            <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">:</span>
</span><span id="NewModel-579"><a href="#NewModel-579"><span class="linenos">579</span></a>                <span class="c1"># find the context to use by searching on drafts by obj_id</span>
</span><span id="NewModel-580"><a href="#NewModel-580"><span class="linenos">580</span></a>                <span class="n">context_result_sequence</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="p">[])</span>
</span><span id="NewModel-581"><a href="#NewModel-581"><span class="linenos">581</span></a>                <span class="c1"># take the old sequence only for the frames before the first frame of the new sequence</span>
</span><span id="NewModel-582"><a href="#NewModel-582"><span class="linenos">582</span></a>                <span class="c1"># and after the last frame of the new sequence</span>
</span><span id="NewModel-583"><a href="#NewModel-583"><span class="linenos">583</span></a>                <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span> <span class="o">+</span> \
</span><span id="NewModel-584"><a href="#NewModel-584"><span class="linenos">584</span></a>                               <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="NewModel-585"><a href="#NewModel-585"><span class="linenos">585</span></a>                               <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span>
</span><span id="NewModel-586"><a href="#NewModel-586"><span class="linenos">586</span></a>                <span class="c1"># take the old labels: take from context if present, otherwise from drafts</span>
</span><span id="NewModel-587"><a href="#NewModel-587"><span class="linenos">587</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="NewModel-588"><a href="#NewModel-588"><span class="linenos">588</span></a>                         <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="NewModel-589"><a href="#NewModel-589"><span class="linenos">589</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel-590"><a href="#NewModel-590"><span class="linenos">590</span></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="NewModel-591"><a href="#NewModel-591"><span class="linenos">591</span></a>                        <span class="s1">&#39;framesCount&#39;</span><span class="p">:</span> <span class="n">frames_count</span><span class="p">,</span>
</span><span id="NewModel-592"><a href="#NewModel-592"><span class="linenos">592</span></a>                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="NewModel-593"><a href="#NewModel-593"><span class="linenos">593</span></a>                        <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">new_sequence</span><span class="p">,</span>
</span><span id="NewModel-594"><a href="#NewModel-594"><span class="linenos">594</span></a>                        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">labels</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="NewModel-595"><a href="#NewModel-595"><span class="linenos">595</span></a>                    <span class="p">},</span>
</span><span id="NewModel-596"><a href="#NewModel-596"><span class="linenos">596</span></a>                    <span class="s1">&#39;from_name&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span>
</span><span id="NewModel-597"><a href="#NewModel-597"><span class="linenos">597</span></a>                    <span class="s1">&#39;to_name&#39;</span><span class="p">:</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span>
</span><span id="NewModel-598"><a href="#NewModel-598"><span class="linenos">598</span></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;videorectangle&#39;</span><span class="p">,</span>
</span><span id="NewModel-599"><a href="#NewModel-599"><span class="linenos">599</span></a>                    <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>
</span><span id="NewModel-600"><a href="#NewModel-600"><span class="linenos">600</span></a>                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="NewModel-601"><a href="#NewModel-601"><span class="linenos">601</span></a>                <span class="p">})</span>
</span><span id="NewModel-602"><a href="#NewModel-602"><span class="linenos">602</span></a>
</span><span id="NewModel-603"><a href="#NewModel-603"><span class="linenos">603</span></a>
</span><span id="NewModel-604"><a href="#NewModel-604"><span class="linenos">604</span></a>            <span class="n">prediction</span> <span class="o">=</span> <span class="n">PredictionValue</span><span class="p">(</span>
</span><span id="NewModel-605"><a href="#NewModel-605"><span class="linenos">605</span></a>                <span class="n">model_version</span><span class="o">=</span><span class="n">MODEL_CHECKPOINT</span><span class="p">,</span>
</span><span id="NewModel-606"><a href="#NewModel-606"><span class="linenos">606</span></a>                <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="NewModel-607"><a href="#NewModel-607"><span class="linenos">607</span></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
</span><span id="NewModel-608"><a href="#NewModel-608"><span class="linenos">608</span></a>            <span class="p">)</span>
</span><span id="NewModel-609"><a href="#NewModel-609"><span class="linenos">609</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction: </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-610"><a href="#NewModel-610"><span class="linenos">610</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel-611"><a href="#NewModel-611"><span class="linenos">611</span></a>              <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prediction.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="NewModel-612"><a href="#NewModel-612"><span class="linenos">612</span></a>                  <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
</span><span id="NewModel-613"><a href="#NewModel-613"><span class="linenos">613</span></a>
</span><span id="NewModel-614"><a href="#NewModel-614"><span class="linenos">614</span></a>            <span class="k">if</span> <span class="n">ANNOTATION_WORKAROUND</span><span class="p">:</span>
</span><span id="NewModel-615"><a href="#NewModel-615"><span class="linenos">615</span></a>                <span class="c1"># this is a workaround to update the annotation in the Label Studio since using the model response shows all the objects with the same label</span>
</span><span id="NewModel-616"><a href="#NewModel-616"><span class="linenos">616</span></a>                <span class="c1"># also if the label is different for each object</span>
</span><span id="NewModel-617"><a href="#NewModel-617"><span class="linenos">617</span></a>                <span class="n">client</span> <span class="o">=</span> <span class="n">LabelStudio</span><span class="p">(</span>
</span><span id="NewModel-618"><a href="#NewModel-618"><span class="linenos">618</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">LABEL_STUDIO_API_KEY</span><span class="p">,</span>
</span><span id="NewModel-619"><a href="#NewModel-619"><span class="linenos">619</span></a>                <span class="p">)</span>
</span><span id="NewModel-620"><a href="#NewModel-620"><span class="linenos">620</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NewModel-621"><a href="#NewModel-621"><span class="linenos">621</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating new annotation&#39;</span><span class="p">)</span>
</span><span id="NewModel-622"><a href="#NewModel-622"><span class="linenos">622</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="NewModel-623"><a href="#NewModel-623"><span class="linenos">623</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="NewModel-624"><a href="#NewModel-624"><span class="linenos">624</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="NewModel-625"><a href="#NewModel-625"><span class="linenos">625</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="NewModel-626"><a href="#NewModel-626"><span class="linenos">626</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="NewModel-627"><a href="#NewModel-627"><span class="linenos">627</span></a>                    <span class="p">)</span>
</span><span id="NewModel-628"><a href="#NewModel-628"><span class="linenos">628</span></a>                    <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="NewModel-629"><a href="#NewModel-629"><span class="linenos">629</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel-630"><a href="#NewModel-630"><span class="linenos">630</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating annotation: </span><span class="si">{</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;annotations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel-631"><a href="#NewModel-631"><span class="linenos">631</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="NewModel-632"><a href="#NewModel-632"><span class="linenos">632</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="NewModel-633"><a href="#NewModel-633"><span class="linenos">633</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="NewModel-634"><a href="#NewModel-634"><span class="linenos">634</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="NewModel-635"><a href="#NewModel-635"><span class="linenos">635</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="NewModel-636"><a href="#NewModel-636"><span class="linenos">636</span></a>                    <span class="p">)</span> <span class="c1"># perche se non lo faccio nella UI mette tutti gli oggetti con la stessa label! sempre!</span>
</span><span id="NewModel-637"><a href="#NewModel-637"><span class="linenos">637</span></a>                <span class="c1"># convert annotation to draft making POST request to http://&lt;IP&gt;/api/annotations/{id}/convert-to-draft</span>
</span><span id="NewModel-638"><a href="#NewModel-638"><span class="linenos">638</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_URL&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/api/annotations/</span><span class="si">{</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">/convert-to-draft&#39;</span>
</span><span id="NewModel-639"><a href="#NewModel-639"><span class="linenos">639</span></a>                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NewModel-640"><a href="#NewModel-640"><span class="linenos">640</span></a>                    <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_API_KEY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="NewModel-641"><a href="#NewModel-641"><span class="linenos">641</span></a>                <span class="p">}</span>
</span><span id="NewModel-642"><a href="#NewModel-642"><span class="linenos">642</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="NewModel-643"><a href="#NewModel-643"><span class="linenos">643</span></a>            <span class="c1"># raise NotImplementedError(&#39;Stop here&#39;)</span>
</span><span id="NewModel-644"><a href="#NewModel-644"><span class="linenos">644</span></a>            <span class="k">return</span> <span class="n">ModelResponse</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="p">[</span><span class="n">prediction</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Custom ML Backend model that integrates with SAM2 for video object segmentation.</p>

<p>This model receives video annotation tasks from Label Studio, extracts prompts (box or point),
and uses SAM2 to track objects through frames. It updates annotations in Label Studio and can
handle multi-object tracking and propagation of segmentation masks.</p>
</div>


                            <div id="NewModel.split_frames" class="classattr">
                                        <input id="NewModel.split_frames-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">split_frames</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">video_path</span>, </span><span class="param"><span class="n">temp_dir</span>, </span><span class="param"><span class="n">start_frame</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">end_frame</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NewModel.split_frames-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel.split_frames"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel.split_frames-131"><a href="#NewModel.split_frames-131"><span class="linenos">131</span></a>    <span class="k">def</span> <span class="nf">split_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="n">start_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="NewModel.split_frames-132"><a href="#NewModel.split_frames-132"><span class="linenos">132</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel.split_frames-133"><a href="#NewModel.split_frames-133"><span class="linenos">133</span></a><span class="sd">        Extract frames from a video file and save them as images in a temporary directory.</span>
</span><span id="NewModel.split_frames-134"><a href="#NewModel.split_frames-134"><span class="linenos">134</span></a>
</span><span id="NewModel.split_frames-135"><a href="#NewModel.split_frames-135"><span class="linenos">135</span></a><span class="sd">        This generator function reads frames from `video_path`, starting from `start_frame` up to</span>
</span><span id="NewModel.split_frames-136"><a href="#NewModel.split_frames-136"><span class="linenos">136</span></a><span class="sd">        (but not including) `end_frame`. Each frame is saved as a JPEG image in `temp_dir` and yielded</span>
</span><span id="NewModel.split_frames-137"><a href="#NewModel.split_frames-137"><span class="linenos">137</span></a><span class="sd">        as `(frame_filename, frame)`.</span>
</span><span id="NewModel.split_frames-138"><a href="#NewModel.split_frames-138"><span class="linenos">138</span></a>
</span><span id="NewModel.split_frames-139"><a href="#NewModel.split_frames-139"><span class="linenos">139</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel.split_frames-140"><a href="#NewModel.split_frames-140"><span class="linenos">140</span></a><span class="sd">        ----------</span>
</span><span id="NewModel.split_frames-141"><a href="#NewModel.split_frames-141"><span class="linenos">141</span></a><span class="sd">        video_path : str</span>
</span><span id="NewModel.split_frames-142"><a href="#NewModel.split_frames-142"><span class="linenos">142</span></a><span class="sd">            Path to the input video file.</span>
</span><span id="NewModel.split_frames-143"><a href="#NewModel.split_frames-143"><span class="linenos">143</span></a><span class="sd">        temp_dir : str</span>
</span><span id="NewModel.split_frames-144"><a href="#NewModel.split_frames-144"><span class="linenos">144</span></a><span class="sd">            Directory where extracted frames will be saved.</span>
</span><span id="NewModel.split_frames-145"><a href="#NewModel.split_frames-145"><span class="linenos">145</span></a><span class="sd">        start_frame : int, optional</span>
</span><span id="NewModel.split_frames-146"><a href="#NewModel.split_frames-146"><span class="linenos">146</span></a><span class="sd">            Index of the first frame to extract (default 0).</span>
</span><span id="NewModel.split_frames-147"><a href="#NewModel.split_frames-147"><span class="linenos">147</span></a><span class="sd">        end_frame : int, optional</span>
</span><span id="NewModel.split_frames-148"><a href="#NewModel.split_frames-148"><span class="linenos">148</span></a><span class="sd">            Index of the frame at which to stop extraction (non-inclusive, default 100).</span>
</span><span id="NewModel.split_frames-149"><a href="#NewModel.split_frames-149"><span class="linenos">149</span></a>
</span><span id="NewModel.split_frames-150"><a href="#NewModel.split_frames-150"><span class="linenos">150</span></a><span class="sd">        Yields</span>
</span><span id="NewModel.split_frames-151"><a href="#NewModel.split_frames-151"><span class="linenos">151</span></a><span class="sd">        ------</span>
</span><span id="NewModel.split_frames-152"><a href="#NewModel.split_frames-152"><span class="linenos">152</span></a><span class="sd">        tuple of (str, np.ndarray)</span>
</span><span id="NewModel.split_frames-153"><a href="#NewModel.split_frames-153"><span class="linenos">153</span></a><span class="sd">            `(frame_filename, frame)`, where `frame_filename` is the path to the saved frame image</span>
</span><span id="NewModel.split_frames-154"><a href="#NewModel.split_frames-154"><span class="linenos">154</span></a><span class="sd">            and `frame` is the frame data as a NumPy array.</span>
</span><span id="NewModel.split_frames-155"><a href="#NewModel.split_frames-155"><span class="linenos">155</span></a>
</span><span id="NewModel.split_frames-156"><a href="#NewModel.split_frames-156"><span class="linenos">156</span></a><span class="sd">        Raises</span>
</span><span id="NewModel.split_frames-157"><a href="#NewModel.split_frames-157"><span class="linenos">157</span></a><span class="sd">        ------</span>
</span><span id="NewModel.split_frames-158"><a href="#NewModel.split_frames-158"><span class="linenos">158</span></a><span class="sd">        ValueError</span>
</span><span id="NewModel.split_frames-159"><a href="#NewModel.split_frames-159"><span class="linenos">159</span></a><span class="sd">            If the video file cannot be opened.</span>
</span><span id="NewModel.split_frames-160"><a href="#NewModel.split_frames-160"><span class="linenos">160</span></a>
</span><span id="NewModel.split_frames-161"><a href="#NewModel.split_frames-161"><span class="linenos">161</span></a><span class="sd">        Notes</span>
</span><span id="NewModel.split_frames-162"><a href="#NewModel.split_frames-162"><span class="linenos">162</span></a><span class="sd">        -----</span>
</span><span id="NewModel.split_frames-163"><a href="#NewModel.split_frames-163"><span class="linenos">163</span></a><span class="sd">        - Frames are saved as JPEG images with zero-padded filenames.</span>
</span><span id="NewModel.split_frames-164"><a href="#NewModel.split_frames-164"><span class="linenos">164</span></a><span class="sd">        - Uses OpenCV (`cv2`) for video operations.</span>
</span><span id="NewModel.split_frames-165"><a href="#NewModel.split_frames-165"><span class="linenos">165</span></a><span class="sd">        - If a frame file already exists, it is not overwritten.</span>
</span><span id="NewModel.split_frames-166"><a href="#NewModel.split_frames-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel.split_frames-167"><a href="#NewModel.split_frames-167"><span class="linenos">167</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opening video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-168"><a href="#NewModel.split_frames-168"><span class="linenos">168</span></a>        <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
</span><span id="NewModel.split_frames-169"><a href="#NewModel.split_frames-169"><span class="linenos">169</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
</span><span id="NewModel.split_frames-170"><a href="#NewModel.split_frames-170"><span class="linenos">170</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">)</span>
</span><span id="NewModel.split_frames-171"><a href="#NewModel.split_frames-171"><span class="linenos">171</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fps: </span><span class="si">{</span><span class="n">fps</span><span class="si">}</span><span class="s1">, frame_count: </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-172"><a href="#NewModel.split_frames-172"><span class="linenos">172</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">frame_count</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="NewModel.split_frames-173"><a href="#NewModel.split_frames-173"><span class="linenos">173</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-174"><a href="#NewModel.split_frames-174"><span class="linenos">174</span></a>
</span><span id="NewModel.split_frames-175"><a href="#NewModel.split_frames-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">video</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
</span><span id="NewModel.split_frames-176"><a href="#NewModel.split_frames-176"><span class="linenos">176</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not open video file: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-177"><a href="#NewModel.split_frames-177"><span class="linenos">177</span></a>
</span><span id="NewModel.split_frames-178"><a href="#NewModel.split_frames-178"><span class="linenos">178</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of frames: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-179"><a href="#NewModel.split_frames-179"><span class="linenos">179</span></a>
</span><span id="NewModel.split_frames-180"><a href="#NewModel.split_frames-180"><span class="linenos">180</span></a>        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="NewModel.split_frames-181"><a href="#NewModel.split_frames-181"><span class="linenos">181</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="NewModel.split_frames-182"><a href="#NewModel.split_frames-182"><span class="linenos">182</span></a>            <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="NewModel.split_frames-183"><a href="#NewModel.split_frames-183"><span class="linenos">183</span></a>
</span><span id="NewModel.split_frames-184"><a href="#NewModel.split_frames-184"><span class="linenos">184</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
</span><span id="NewModel.split_frames-185"><a href="#NewModel.split_frames-185"><span class="linenos">185</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to read frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-186"><a href="#NewModel.split_frames-186"><span class="linenos">186</span></a>                <span class="c1"># manage this (frame 57 of acutal video test)</span>
</span><span id="NewModel.split_frames-187"><a href="#NewModel.split_frames-187"><span class="linenos">187</span></a>                <span class="c1"># poi risovli il problema del label con diverse etichette</span>
</span><span id="NewModel.split_frames-188"><a href="#NewModel.split_frames-188"><span class="linenos">188</span></a>                <span class="k">break</span>
</span><span id="NewModel.split_frames-189"><a href="#NewModel.split_frames-189"><span class="linenos">189</span></a>
</span><span id="NewModel.split_frames-190"><a href="#NewModel.split_frames-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&lt;</span> <span class="n">start_frame</span><span class="p">:</span>
</span><span id="NewModel.split_frames-191"><a href="#NewModel.split_frames-191"><span class="linenos">191</span></a>                <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="NewModel.split_frames-192"><a href="#NewModel.split_frames-192"><span class="linenos">192</span></a>                <span class="k">continue</span>
</span><span id="NewModel.split_frames-193"><a href="#NewModel.split_frames-193"><span class="linenos">193</span></a>
</span><span id="NewModel.split_frames-194"><a href="#NewModel.split_frames-194"><span class="linenos">194</span></a>            <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;=</span> <span class="n">end_frame</span><span class="p">:</span>
</span><span id="NewModel.split_frames-195"><a href="#NewModel.split_frames-195"><span class="linenos">195</span></a>                <span class="k">break</span>
</span><span id="NewModel.split_frames-196"><a href="#NewModel.split_frames-196"><span class="linenos">196</span></a>
</span><span id="NewModel.split_frames-197"><a href="#NewModel.split_frames-197"><span class="linenos">197</span></a>            <span class="n">frame_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frame_count</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-198"><a href="#NewModel.split_frames-198"><span class="linenos">198</span></a>
</span><span id="NewModel.split_frames-199"><a href="#NewModel.split_frames-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">):</span>
</span><span id="NewModel.split_frames-200"><a href="#NewModel.split_frames-200"><span class="linenos">200</span></a>                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</span><span id="NewModel.split_frames-201"><a href="#NewModel.split_frames-201"><span class="linenos">201</span></a>
</span><span id="NewModel.split_frames-202"><a href="#NewModel.split_frames-202"><span class="linenos">202</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">frame_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.split_frames-203"><a href="#NewModel.split_frames-203"><span class="linenos">203</span></a>            <span class="k">yield</span> <span class="n">frame_filename</span><span class="p">,</span> <span class="n">frame</span>
</span><span id="NewModel.split_frames-204"><a href="#NewModel.split_frames-204"><span class="linenos">204</span></a>            <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="NewModel.split_frames-205"><a href="#NewModel.split_frames-205"><span class="linenos">205</span></a>
</span><span id="NewModel.split_frames-206"><a href="#NewModel.split_frames-206"><span class="linenos">206</span></a>        <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Extract frames from a video file and save them as images in a temporary directory.</p>

<p>This generator function reads frames from <code>video_path</code>, starting from <code>start_frame</code> up to
(but not including) <code>end_frame</code>. Each frame is saved as a JPEG image in <code>temp_dir</code> and yielded
as <code>(frame_filename, frame)</code>.</p>

<h2 id="parameters">Parameters</h2>

<p>video_path : str
    Path to the input video file.
temp_dir : str
    Directory where extracted frames will be saved.
start_frame : int, optional
    Index of the first frame to extract (default 0).
end_frame : int, optional
    Index of the frame at which to stop extraction (non-inclusive, default 100).</p>

<h2 id="yields">Yields</h2>

<p>tuple of (str, np.ndarray)
    <code>(frame_filename, frame)</code>, where <code>frame_filename</code> is the path to the saved frame image
    and <code>frame</code> is the frame data as a NumPy array.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If the video file cannot be opened.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>Frames are saved as JPEG images with zero-padded filenames.</li>
<li>Uses OpenCV (<code>cv2</code>) for video operations.</li>
<li>If a frame file already exists, it is not overwritten.</li>
</ul>
</div>


                            </div>
                            <div id="NewModel.get_prompts" class="classattr">
                                        <input id="NewModel.get_prompts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_prompts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">context</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NewModel.get_prompts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel.get_prompts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel.get_prompts-208"><a href="#NewModel.get_prompts-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="NewModel.get_prompts-209"><a href="#NewModel.get_prompts-209"><span class="linenos">209</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel.get_prompts-210"><a href="#NewModel.get_prompts-210"><span class="linenos">210</span></a><span class="sd">        Extract prompts from the annotation context for use with the SAM2 model.</span>
</span><span id="NewModel.get_prompts-211"><a href="#NewModel.get_prompts-211"><span class="linenos">211</span></a>
</span><span id="NewModel.get_prompts-212"><a href="#NewModel.get_prompts-212"><span class="linenos">212</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel.get_prompts-213"><a href="#NewModel.get_prompts-213"><span class="linenos">213</span></a><span class="sd">        ----------</span>
</span><span id="NewModel.get_prompts-214"><a href="#NewModel.get_prompts-214"><span class="linenos">214</span></a><span class="sd">        context : dict</span>
</span><span id="NewModel.get_prompts-215"><a href="#NewModel.get_prompts-215"><span class="linenos">215</span></a><span class="sd">            A dictionary containing annotation results, including frame-based bounding boxes or points.</span>
</span><span id="NewModel.get_prompts-216"><a href="#NewModel.get_prompts-216"><span class="linenos">216</span></a><span class="sd">            The format is typically from Label Studio&#39;s `drafts` or `context`, with a &#39;result&#39; key.</span>
</span><span id="NewModel.get_prompts-217"><a href="#NewModel.get_prompts-217"><span class="linenos">217</span></a>
</span><span id="NewModel.get_prompts-218"><a href="#NewModel.get_prompts-218"><span class="linenos">218</span></a><span class="sd">        Returns</span>
</span><span id="NewModel.get_prompts-219"><a href="#NewModel.get_prompts-219"><span class="linenos">219</span></a><span class="sd">        -------</span>
</span><span id="NewModel.get_prompts-220"><a href="#NewModel.get_prompts-220"><span class="linenos">220</span></a><span class="sd">        List[Dict]</span>
</span><span id="NewModel.get_prompts-221"><a href="#NewModel.get_prompts-221"><span class="linenos">221</span></a><span class="sd">            A list of prompt dictionaries. Each contains:</span>
</span><span id="NewModel.get_prompts-222"><a href="#NewModel.get_prompts-222"><span class="linenos">222</span></a><span class="sd">            - &#39;points&#39;: np.ndarray of keypoints/box coords</span>
</span><span id="NewModel.get_prompts-223"><a href="#NewModel.get_prompts-223"><span class="linenos">223</span></a><span class="sd">            - &#39;labels&#39;: np.ndarray or None (for point prompts)</span>
</span><span id="NewModel.get_prompts-224"><a href="#NewModel.get_prompts-224"><span class="linenos">224</span></a><span class="sd">            - &#39;frame_idx&#39;: int zero-based frame index</span>
</span><span id="NewModel.get_prompts-225"><a href="#NewModel.get_prompts-225"><span class="linenos">225</span></a><span class="sd">            - &#39;obj_id&#39;: str object identifier</span>
</span><span id="NewModel.get_prompts-226"><a href="#NewModel.get_prompts-226"><span class="linenos">226</span></a>
</span><span id="NewModel.get_prompts-227"><a href="#NewModel.get_prompts-227"><span class="linenos">227</span></a><span class="sd">        Raises</span>
</span><span id="NewModel.get_prompts-228"><a href="#NewModel.get_prompts-228"><span class="linenos">228</span></a><span class="sd">        ------</span>
</span><span id="NewModel.get_prompts-229"><a href="#NewModel.get_prompts-229"><span class="linenos">229</span></a><span class="sd">        ValueError</span>
</span><span id="NewModel.get_prompts-230"><a href="#NewModel.get_prompts-230"><span class="linenos">230</span></a><span class="sd">            If PROMPT_TYPE is neither &#39;point&#39; nor &#39;box&#39;.</span>
</span><span id="NewModel.get_prompts-231"><a href="#NewModel.get_prompts-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel.get_prompts-232"><a href="#NewModel.get_prompts-232"><span class="linenos">232</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extracting keypoints from context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.get_prompts-233"><a href="#NewModel.get_prompts-233"><span class="linenos">233</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NewModel.get_prompts-234"><a href="#NewModel.get_prompts-234"><span class="linenos">234</span></a>        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
</span><span id="NewModel.get_prompts-235"><a href="#NewModel.get_prompts-235"><span class="linenos">235</span></a>            <span class="c1"># Process each video tracking object separately</span>
</span><span id="NewModel.get_prompts-236"><a href="#NewModel.get_prompts-236"><span class="linenos">236</span></a>            <span class="n">obj_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="NewModel.get_prompts-237"><a href="#NewModel.get_prompts-237"><span class="linenos">237</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]:</span>
</span><span id="NewModel.get_prompts-238"><a href="#NewModel.get_prompts-238"><span class="linenos">238</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel.get_prompts-239"><a href="#NewModel.get_prompts-239"><span class="linenos">239</span></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel.get_prompts-240"><a href="#NewModel.get_prompts-240"><span class="linenos">240</span></a>                <span class="n">box_width</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel.get_prompts-241"><a href="#NewModel.get_prompts-241"><span class="linenos">241</span></a>                <span class="n">box_height</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
</span><span id="NewModel.get_prompts-242"><a href="#NewModel.get_prompts-242"><span class="linenos">242</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="NewModel.get_prompts-243"><a href="#NewModel.get_prompts-243"><span class="linenos">243</span></a>
</span><span id="NewModel.get_prompts-244"><a href="#NewModel.get_prompts-244"><span class="linenos">244</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="NewModel.get_prompts-245"><a href="#NewModel.get_prompts-245"><span class="linenos">245</span></a>                    <span class="c1"># SAM2 video works with keypoints - convert the rectangle to the set of keypoints within the rectangle</span>
</span><span id="NewModel.get_prompts-246"><a href="#NewModel.get_prompts-246"><span class="linenos">246</span></a>                    <span class="c1"># bbox (x, y) is top-left corner</span>
</span><span id="NewModel.get_prompts-247"><a href="#NewModel.get_prompts-247"><span class="linenos">247</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="NewModel.get_prompts-248"><a href="#NewModel.get_prompts-248"><span class="linenos">248</span></a>                        <span class="c1"># center of the bbox</span>
</span><span id="NewModel.get_prompts-249"><a href="#NewModel.get_prompts-249"><span class="linenos">249</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel.get_prompts-250"><a href="#NewModel.get_prompts-250"><span class="linenos">250</span></a>                        <span class="c1"># half of the bbox width to the left</span>
</span><span id="NewModel.get_prompts-251"><a href="#NewModel.get_prompts-251"><span class="linenos">251</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel.get_prompts-252"><a href="#NewModel.get_prompts-252"><span class="linenos">252</span></a>                        <span class="c1"># half of the bbox width to the right</span>
</span><span id="NewModel.get_prompts-253"><a href="#NewModel.get_prompts-253"><span class="linenos">253</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="NewModel.get_prompts-254"><a href="#NewModel.get_prompts-254"><span class="linenos">254</span></a>                        <span class="c1"># half of the bbox height to the top</span>
</span><span id="NewModel.get_prompts-255"><a href="#NewModel.get_prompts-255"><span class="linenos">255</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="NewModel.get_prompts-256"><a href="#NewModel.get_prompts-256"><span class="linenos">256</span></a>                        <span class="c1"># half of the bbox height to the bottom</span>
</span><span id="NewModel.get_prompts-257"><a href="#NewModel.get_prompts-257"><span class="linenos">257</span></a>                        <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">box_height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span>
</span><span id="NewModel.get_prompts-258"><a href="#NewModel.get_prompts-258"><span class="linenos">258</span></a>                    <span class="p">]</span>
</span><span id="NewModel.get_prompts-259"><a href="#NewModel.get_prompts-259"><span class="linenos">259</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="NewModel.get_prompts-260"><a href="#NewModel.get_prompts-260"><span class="linenos">260</span></a>                    <span class="c1"># SAM2 video works with boxes - use the rectangle inf xyxy format</span>
</span><span id="NewModel.get_prompts-261"><a href="#NewModel.get_prompts-261"><span class="linenos">261</span></a>                    <span class="n">kps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">box_width</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">box_height</span><span class="p">]</span>
</span><span id="NewModel.get_prompts-262"><a href="#NewModel.get_prompts-262"><span class="linenos">262</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel.get_prompts-263"><a href="#NewModel.get_prompts-263"><span class="linenos">263</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid prompt type: </span><span class="si">{</span><span class="n">PROMPT_TYPE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.get_prompts-264"><a href="#NewModel.get_prompts-264"><span class="linenos">264</span></a>
</span><span id="NewModel.get_prompts-265"><a href="#NewModel.get_prompts-265"><span class="linenos">265</span></a>                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NewModel.get_prompts-266"><a href="#NewModel.get_prompts-266"><span class="linenos">266</span></a>                <span class="c1"># labels are not used for box prompts</span>
</span><span id="NewModel.get_prompts-267"><a href="#NewModel.get_prompts-267"><span class="linenos">267</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NewModel.get_prompts-268"><a href="#NewModel.get_prompts-268"><span class="linenos">268</span></a>                <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel.get_prompts-269"><a href="#NewModel.get_prompts-269"><span class="linenos">269</span></a>                    <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
</span><span id="NewModel.get_prompts-270"><a href="#NewModel.get_prompts-270"><span class="linenos">270</span></a>                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
</span><span id="NewModel.get_prompts-271"><a href="#NewModel.get_prompts-271"><span class="linenos">271</span></a>                    <span class="s1">&#39;frame_idx&#39;</span><span class="p">:</span> <span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel.get_prompts-272"><a href="#NewModel.get_prompts-272"><span class="linenos">272</span></a>                    <span class="s1">&#39;obj_id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="NewModel.get_prompts-273"><a href="#NewModel.get_prompts-273"><span class="linenos">273</span></a>                <span class="p">})</span>
</span><span id="NewModel.get_prompts-274"><a href="#NewModel.get_prompts-274"><span class="linenos">274</span></a>
</span><span id="NewModel.get_prompts-275"><a href="#NewModel.get_prompts-275"><span class="linenos">275</span></a>        <span class="k">return</span> <span class="n">prompts</span>
</span></pre></div>


            <div class="docstring"><p>Extract prompts from the annotation context for use with the SAM2 model.</p>

<h2 id="parameters">Parameters</h2>

<p>context : dict
    A dictionary containing annotation results, including frame-based bounding boxes or points.
    The format is typically from Label Studio's <code>drafts</code> or <code>context</code>, with a 'result' key.</p>

<h2 id="returns">Returns</h2>

<p>List[Dict]
    A list of prompt dictionaries. Each contains:
    - 'points': np.ndarray of keypoints/box coords
    - 'labels': np.ndarray or None (for point prompts)
    - 'frame_idx': int zero-based frame index
    - 'obj_id': str object identifier</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If PROMPT_TYPE is neither 'point' nor 'box'.</p>
</div>


                            </div>
                            <div id="NewModel.convert_mask_to_bbox" class="classattr">
                                        <input id="NewModel.convert_mask_to_bbox-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_mask_to_bbox</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NewModel.convert_mask_to_bbox-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel.convert_mask_to_bbox"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel.convert_mask_to_bbox-311"><a href="#NewModel.convert_mask_to_bbox-311"><span class="linenos">311</span></a>    <span class="k">def</span> <span class="nf">convert_mask_to_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="NewModel.convert_mask_to_bbox-312"><a href="#NewModel.convert_mask_to_bbox-312"><span class="linenos">312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel.convert_mask_to_bbox-313"><a href="#NewModel.convert_mask_to_bbox-313"><span class="linenos">313</span></a><span class="sd">        Convert a binary mask to a bounding box in normalized percentages.</span>
</span><span id="NewModel.convert_mask_to_bbox-314"><a href="#NewModel.convert_mask_to_bbox-314"><span class="linenos">314</span></a>
</span><span id="NewModel.convert_mask_to_bbox-315"><a href="#NewModel.convert_mask_to_bbox-315"><span class="linenos">315</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel.convert_mask_to_bbox-316"><a href="#NewModel.convert_mask_to_bbox-316"><span class="linenos">316</span></a><span class="sd">        ----------</span>
</span><span id="NewModel.convert_mask_to_bbox-317"><a href="#NewModel.convert_mask_to_bbox-317"><span class="linenos">317</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="NewModel.convert_mask_to_bbox-318"><a href="#NewModel.convert_mask_to_bbox-318"><span class="linenos">318</span></a><span class="sd">            A binary mask of shape (H, W) where 1 indicates object pixels.</span>
</span><span id="NewModel.convert_mask_to_bbox-319"><a href="#NewModel.convert_mask_to_bbox-319"><span class="linenos">319</span></a>
</span><span id="NewModel.convert_mask_to_bbox-320"><a href="#NewModel.convert_mask_to_bbox-320"><span class="linenos">320</span></a><span class="sd">        Returns</span>
</span><span id="NewModel.convert_mask_to_bbox-321"><a href="#NewModel.convert_mask_to_bbox-321"><span class="linenos">321</span></a><span class="sd">        -------</span>
</span><span id="NewModel.convert_mask_to_bbox-322"><a href="#NewModel.convert_mask_to_bbox-322"><span class="linenos">322</span></a><span class="sd">        dict or None</span>
</span><span id="NewModel.convert_mask_to_bbox-323"><a href="#NewModel.convert_mask_to_bbox-323"><span class="linenos">323</span></a><span class="sd">            A dictionary with keys &#39;x&#39;, &#39;y&#39;, &#39;width&#39;, &#39;height&#39; representing the bounding box in percentage,</span>
</span><span id="NewModel.convert_mask_to_bbox-324"><a href="#NewModel.convert_mask_to_bbox-324"><span class="linenos">324</span></a><span class="sd">            or None if no object pixels are found.</span>
</span><span id="NewModel.convert_mask_to_bbox-325"><a href="#NewModel.convert_mask_to_bbox-325"><span class="linenos">325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel.convert_mask_to_bbox-326"><a href="#NewModel.convert_mask_to_bbox-326"><span class="linenos">326</span></a>        <span class="c1"># squeeze</span>
</span><span id="NewModel.convert_mask_to_bbox-327"><a href="#NewModel.convert_mask_to_bbox-327"><span class="linenos">327</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="NewModel.convert_mask_to_bbox-328"><a href="#NewModel.convert_mask_to_bbox-328"><span class="linenos">328</span></a>
</span><span id="NewModel.convert_mask_to_bbox-329"><a href="#NewModel.convert_mask_to_bbox-329"><span class="linenos">329</span></a>        <span class="n">y_indices</span><span class="p">,</span> <span class="n">x_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="NewModel.convert_mask_to_bbox-330"><a href="#NewModel.convert_mask_to_bbox-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NewModel.convert_mask_to_bbox-331"><a href="#NewModel.convert_mask_to_bbox-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="NewModel.convert_mask_to_bbox-332"><a href="#NewModel.convert_mask_to_bbox-332"><span class="linenos">332</span></a>
</span><span id="NewModel.convert_mask_to_bbox-333"><a href="#NewModel.convert_mask_to_bbox-333"><span class="linenos">333</span></a>        <span class="c1"># Find the min and max indices</span>
</span><span id="NewModel.convert_mask_to_bbox-334"><a href="#NewModel.convert_mask_to_bbox-334"><span class="linenos">334</span></a>        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_indices</span><span class="p">)</span>
</span><span id="NewModel.convert_mask_to_bbox-335"><a href="#NewModel.convert_mask_to_bbox-335"><span class="linenos">335</span></a>        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_indices</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_indices</span><span class="p">)</span>
</span><span id="NewModel.convert_mask_to_bbox-336"><a href="#NewModel.convert_mask_to_bbox-336"><span class="linenos">336</span></a>
</span><span id="NewModel.convert_mask_to_bbox-337"><a href="#NewModel.convert_mask_to_bbox-337"><span class="linenos">337</span></a>        <span class="c1"># Get mask dimensions</span>
</span><span id="NewModel.convert_mask_to_bbox-338"><a href="#NewModel.convert_mask_to_bbox-338"><span class="linenos">338</span></a>        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NewModel.convert_mask_to_bbox-339"><a href="#NewModel.convert_mask_to_bbox-339"><span class="linenos">339</span></a>
</span><span id="NewModel.convert_mask_to_bbox-340"><a href="#NewModel.convert_mask_to_bbox-340"><span class="linenos">340</span></a>        <span class="c1"># Calculate bounding box dimensions</span>
</span><span id="NewModel.convert_mask_to_bbox-341"><a href="#NewModel.convert_mask_to_bbox-341"><span class="linenos">341</span></a>        <span class="n">box_width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="NewModel.convert_mask_to_bbox-342"><a href="#NewModel.convert_mask_to_bbox-342"><span class="linenos">342</span></a>        <span class="n">box_height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="NewModel.convert_mask_to_bbox-343"><a href="#NewModel.convert_mask_to_bbox-343"><span class="linenos">343</span></a>
</span><span id="NewModel.convert_mask_to_bbox-344"><a href="#NewModel.convert_mask_to_bbox-344"><span class="linenos">344</span></a>        <span class="c1"># Normalize and scale to percentage</span>
</span><span id="NewModel.convert_mask_to_bbox-345"><a href="#NewModel.convert_mask_to_bbox-345"><span class="linenos">345</span></a>        <span class="n">x_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel.convert_mask_to_bbox-346"><a href="#NewModel.convert_mask_to_bbox-346"><span class="linenos">346</span></a>        <span class="n">y_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel.convert_mask_to_bbox-347"><a href="#NewModel.convert_mask_to_bbox-347"><span class="linenos">347</span></a>        <span class="n">width_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel.convert_mask_to_bbox-348"><a href="#NewModel.convert_mask_to_bbox-348"><span class="linenos">348</span></a>        <span class="n">height_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_height</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="NewModel.convert_mask_to_bbox-349"><a href="#NewModel.convert_mask_to_bbox-349"><span class="linenos">349</span></a>
</span><span id="NewModel.convert_mask_to_bbox-350"><a href="#NewModel.convert_mask_to_bbox-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="NewModel.convert_mask_to_bbox-351"><a href="#NewModel.convert_mask_to_bbox-351"><span class="linenos">351</span></a>            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel.convert_mask_to_bbox-352"><a href="#NewModel.convert_mask_to_bbox-352"><span class="linenos">352</span></a>            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel.convert_mask_to_bbox-353"><a href="#NewModel.convert_mask_to_bbox-353"><span class="linenos">353</span></a>            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">width_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="NewModel.convert_mask_to_bbox-354"><a href="#NewModel.convert_mask_to_bbox-354"><span class="linenos">354</span></a>            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">height_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="NewModel.convert_mask_to_bbox-355"><a href="#NewModel.convert_mask_to_bbox-355"><span class="linenos">355</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Convert a binary mask to a bounding box in normalized percentages.</p>

<h2 id="parameters">Parameters</h2>

<p>mask : np.ndarray
    A binary mask of shape (H, W) where 1 indicates object pixels.</p>

<h2 id="returns">Returns</h2>

<p>dict or None
    A dictionary with keys 'x', 'y', 'width', 'height' representing the bounding box in percentage,
    or None if no object pixels are found.</p>
</div>


                            </div>
                            <div id="NewModel.dump_image_with_mask" class="classattr">
                                        <input id="NewModel.dump_image_with_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dump_image_with_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">frame</span>, </span><span class="param"><span class="n">mask</span>, </span><span class="param"><span class="n">output_file</span>, </span><span class="param"><span class="n">obj_id</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">random_color</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NewModel.dump_image_with_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel.dump_image_with_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel.dump_image_with_mask-358"><a href="#NewModel.dump_image_with_mask-358"><span class="linenos">358</span></a>    <span class="k">def</span> <span class="nf">dump_image_with_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NewModel.dump_image_with_mask-359"><a href="#NewModel.dump_image_with_mask-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel.dump_image_with_mask-360"><a href="#NewModel.dump_image_with_mask-360"><span class="linenos">360</span></a><span class="sd">        Debug utility to overlay a mask onto a frame and save it as an image file.</span>
</span><span id="NewModel.dump_image_with_mask-361"><a href="#NewModel.dump_image_with_mask-361"><span class="linenos">361</span></a>
</span><span id="NewModel.dump_image_with_mask-362"><a href="#NewModel.dump_image_with_mask-362"><span class="linenos">362</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel.dump_image_with_mask-363"><a href="#NewModel.dump_image_with_mask-363"><span class="linenos">363</span></a><span class="sd">        ----------</span>
</span><span id="NewModel.dump_image_with_mask-364"><a href="#NewModel.dump_image_with_mask-364"><span class="linenos">364</span></a><span class="sd">        frame : np.ndarray</span>
</span><span id="NewModel.dump_image_with_mask-365"><a href="#NewModel.dump_image_with_mask-365"><span class="linenos">365</span></a><span class="sd">            The original frame image (H, W, C).</span>
</span><span id="NewModel.dump_image_with_mask-366"><a href="#NewModel.dump_image_with_mask-366"><span class="linenos">366</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="NewModel.dump_image_with_mask-367"><a href="#NewModel.dump_image_with_mask-367"><span class="linenos">367</span></a><span class="sd">            A binary mask for the object (H, W).</span>
</span><span id="NewModel.dump_image_with_mask-368"><a href="#NewModel.dump_image_with_mask-368"><span class="linenos">368</span></a><span class="sd">        output_file : str</span>
</span><span id="NewModel.dump_image_with_mask-369"><a href="#NewModel.dump_image_with_mask-369"><span class="linenos">369</span></a><span class="sd">            Path to save the output image.</span>
</span><span id="NewModel.dump_image_with_mask-370"><a href="#NewModel.dump_image_with_mask-370"><span class="linenos">370</span></a><span class="sd">        obj_id : int, optional</span>
</span><span id="NewModel.dump_image_with_mask-371"><a href="#NewModel.dump_image_with_mask-371"><span class="linenos">371</span></a><span class="sd">            Object identifier to pick a color from a colormap.</span>
</span><span id="NewModel.dump_image_with_mask-372"><a href="#NewModel.dump_image_with_mask-372"><span class="linenos">372</span></a><span class="sd">        random_color : bool, optional</span>
</span><span id="NewModel.dump_image_with_mask-373"><a href="#NewModel.dump_image_with_mask-373"><span class="linenos">373</span></a><span class="sd">            If True, use a random color for the mask overlay.</span>
</span><span id="NewModel.dump_image_with_mask-374"><a href="#NewModel.dump_image_with_mask-374"><span class="linenos">374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel.dump_image_with_mask-375"><a href="#NewModel.dump_image_with_mask-375"><span class="linenos">375</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="NewModel.dump_image_with_mask-376"><a href="#NewModel.dump_image_with_mask-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="n">random_color</span><span class="p">:</span>
</span><span id="NewModel.dump_image_with_mask-377"><a href="#NewModel.dump_image_with_mask-377"><span class="linenos">377</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.6</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-378"><a href="#NewModel.dump_image_with_mask-378"><span class="linenos">378</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel.dump_image_with_mask-379"><a href="#NewModel.dump_image_with_mask-379"><span class="linenos">379</span></a>            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-380"><a href="#NewModel.dump_image_with_mask-380"><span class="linenos">380</span></a>            <span class="n">cmap_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">obj_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">obj_id</span>
</span><span id="NewModel.dump_image_with_mask-381"><a href="#NewModel.dump_image_with_mask-381"><span class="linenos">381</span></a>            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">cmap_idx</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">])</span>
</span><span id="NewModel.dump_image_with_mask-382"><a href="#NewModel.dump_image_with_mask-382"><span class="linenos">382</span></a>        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span><span id="NewModel.dump_image_with_mask-383"><a href="#NewModel.dump_image_with_mask-383"><span class="linenos">383</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-384"><a href="#NewModel.dump_image_with_mask-384"><span class="linenos">384</span></a>
</span><span id="NewModel.dump_image_with_mask-385"><a href="#NewModel.dump_image_with_mask-385"><span class="linenos">385</span></a>        <span class="c1"># create an image file to display image overlayed with mask</span>
</span><span id="NewModel.dump_image_with_mask-386"><a href="#NewModel.dump_image_with_mask-386"><span class="linenos">386</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_image</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-387"><a href="#NewModel.dump_image_with_mask-387"><span class="linenos">387</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGRA2BGR</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-388"><a href="#NewModel.dump_image_with_mask-388"><span class="linenos">388</span></a>        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-389"><a href="#NewModel.dump_image_with_mask-389"><span class="linenos">389</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapes: frame=</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask=</span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, mask_image=</span><span class="si">{</span><span class="n">mask_image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-390"><a href="#NewModel.dump_image_with_mask-390"><span class="linenos">390</span></a>        <span class="c1"># save in file</span>
</span><span id="NewModel.dump_image_with_mask-391"><a href="#NewModel.dump_image_with_mask-391"><span class="linenos">391</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving image with mask to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.dump_image_with_mask-392"><a href="#NewModel.dump_image_with_mask-392"><span class="linenos">392</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mask_image</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Debug utility to overlay a mask onto a frame and save it as an image file.</p>

<h2 id="parameters">Parameters</h2>

<p>frame : np.ndarray
    The original frame image (H, W, C).
mask : np.ndarray
    A binary mask for the object (H, W).
output_file : str
    Path to save the output image.
obj_id : int, optional
    Object identifier to pick a color from a colormap.
random_color : bool, optional
    If True, use a random color for the mask overlay.</p>
</div>


                            </div>
                            <div id="NewModel.predict" class="classattr">
                                        <input id="NewModel.predict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">label_studio_ml</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">ModelResponse</span>:</span></span>

                <label class="view-source-button" for="NewModel.predict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NewModel.predict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NewModel.predict-395"><a href="#NewModel.predict-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelResponse</span><span class="p">:</span>
</span><span id="NewModel.predict-396"><a href="#NewModel.predict-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NewModel.predict-397"><a href="#NewModel.predict-397"><span class="linenos">397</span></a><span class="sd">        Run the prediction to generate segmentation masks for a given set of video frames.</span>
</span><span id="NewModel.predict-398"><a href="#NewModel.predict-398"><span class="linenos">398</span></a>
</span><span id="NewModel.predict-399"><a href="#NewModel.predict-399"><span class="linenos">399</span></a><span class="sd">        The model:</span>
</span><span id="NewModel.predict-400"><a href="#NewModel.predict-400"><span class="linenos">400</span></a><span class="sd">        1. Extracts prompts (boxes/points) from the given tasks and drafts.</span>
</span><span id="NewModel.predict-401"><a href="#NewModel.predict-401"><span class="linenos">401</span></a><span class="sd">        2. Uses the SAM2 predictor to track the object(s) through frames.</span>
</span><span id="NewModel.predict-402"><a href="#NewModel.predict-402"><span class="linenos">402</span></a><span class="sd">        3. Updates annotations in Label Studio with the new masks and bounding boxes.</span>
</span><span id="NewModel.predict-403"><a href="#NewModel.predict-403"><span class="linenos">403</span></a>
</span><span id="NewModel.predict-404"><a href="#NewModel.predict-404"><span class="linenos">404</span></a><span class="sd">        Parameters</span>
</span><span id="NewModel.predict-405"><a href="#NewModel.predict-405"><span class="linenos">405</span></a><span class="sd">        ----------</span>
</span><span id="NewModel.predict-406"><a href="#NewModel.predict-406"><span class="linenos">406</span></a><span class="sd">        tasks : list of dict</span>
</span><span id="NewModel.predict-407"><a href="#NewModel.predict-407"><span class="linenos">407</span></a><span class="sd">            List of tasks to be annotated, each containing video data and drafts or annotations.</span>
</span><span id="NewModel.predict-408"><a href="#NewModel.predict-408"><span class="linenos">408</span></a><span class="sd">        context : dict, optional</span>
</span><span id="NewModel.predict-409"><a href="#NewModel.predict-409"><span class="linenos">409</span></a><span class="sd">            Additional context with annotation results. If no drafts are found, context is used as a fallback.</span>
</span><span id="NewModel.predict-410"><a href="#NewModel.predict-410"><span class="linenos">410</span></a><span class="sd">        **kwargs</span>
</span><span id="NewModel.predict-411"><a href="#NewModel.predict-411"><span class="linenos">411</span></a><span class="sd">            Additional keyword arguments (unused).</span>
</span><span id="NewModel.predict-412"><a href="#NewModel.predict-412"><span class="linenos">412</span></a>
</span><span id="NewModel.predict-413"><a href="#NewModel.predict-413"><span class="linenos">413</span></a><span class="sd">        Returns</span>
</span><span id="NewModel.predict-414"><a href="#NewModel.predict-414"><span class="linenos">414</span></a><span class="sd">        -------</span>
</span><span id="NewModel.predict-415"><a href="#NewModel.predict-415"><span class="linenos">415</span></a><span class="sd">        ModelResponse</span>
</span><span id="NewModel.predict-416"><a href="#NewModel.predict-416"><span class="linenos">416</span></a><span class="sd">            A structured response containing updated annotations for Label Studio.</span>
</span><span id="NewModel.predict-417"><a href="#NewModel.predict-417"><span class="linenos">417</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NewModel.predict-418"><a href="#NewModel.predict-418"><span class="linenos">418</span></a>        <span class="n">from_name</span><span class="p">,</span> <span class="n">to_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_tag_occurence</span><span class="p">(</span><span class="s1">&#39;VideoRectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;Video&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-419"><a href="#NewModel.predict-419"><span class="linenos">419</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NewModel.predict-420"><a href="#NewModel.predict-420"><span class="linenos">420</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;drafts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel.predict-421"><a href="#NewModel.predict-421"><span class="linenos">421</span></a>        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="NewModel.predict-422"><a href="#NewModel.predict-422"><span class="linenos">422</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Drafts not found, using annotations&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-423"><a href="#NewModel.predict-423"><span class="linenos">423</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="NewModel.predict-424"><a href="#NewModel.predict-424"><span class="linenos">424</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel.predict-425"><a href="#NewModel.predict-425"><span class="linenos">425</span></a>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="NewModel.predict-426"><a href="#NewModel.predict-426"><span class="linenos">426</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Annotations not found, using context&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-427"><a href="#NewModel.predict-427"><span class="linenos">427</span></a>                <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NewModel.predict-428"><a href="#NewModel.predict-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">drafts</span><span class="p">):</span>
</span><span id="NewModel.predict-429"><a href="#NewModel.predict-429"><span class="linenos">429</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Draft empty, using context&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-430"><a href="#NewModel.predict-430"><span class="linenos">430</span></a>            <span class="n">drafts</span> <span class="o">=</span> <span class="n">context</span>
</span><span id="NewModel.predict-431"><a href="#NewModel.predict-431"><span class="linenos">431</span></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NewModel.predict-432"><a href="#NewModel.predict-432"><span class="linenos">432</span></a>        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="NewModel.predict-433"><a href="#NewModel.predict-433"><span class="linenos">433</span></a>        <span class="c1"># Get the video URL from the task</span>
</span><span id="NewModel.predict-434"><a href="#NewModel.predict-434"><span class="linenos">434</span></a>        <span class="n">video_url</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">value</span><span class="p">]</span>
</span><span id="NewModel.predict-435"><a href="#NewModel.predict-435"><span class="linenos">435</span></a>
</span><span id="NewModel.predict-436"><a href="#NewModel.predict-436"><span class="linenos">436</span></a>        <span class="c1"># cache the video locally</span>
</span><span id="NewModel.predict-437"><a href="#NewModel.predict-437"><span class="linenos">437</span></a>        <span class="n">video_path</span> <span class="o">=</span> <span class="n">get_local_path</span><span class="p">(</span><span class="n">video_url</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">)</span>
</span><span id="NewModel.predict-438"><a href="#NewModel.predict-438"><span class="linenos">438</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video path: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-439"><a href="#NewModel.predict-439"><span class="linenos">439</span></a>
</span><span id="NewModel.predict-440"><a href="#NewModel.predict-440"><span class="linenos">440</span></a>        <span class="c1"># get prompts from context</span>
</span><span id="NewModel.predict-441"><a href="#NewModel.predict-441"><span class="linenos">441</span></a>        <span class="c1"># prompts = self.get_prompts(context)</span>
</span><span id="NewModel.predict-442"><a href="#NewModel.predict-442"><span class="linenos">442</span></a>        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prompts</span><span class="p">(</span><span class="n">drafts</span><span class="p">)</span>
</span><span id="NewModel.predict-443"><a href="#NewModel.predict-443"><span class="linenos">443</span></a>
</span><span id="NewModel.predict-444"><a href="#NewModel.predict-444"><span class="linenos">444</span></a>        <span class="n">context_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]])</span>
</span><span id="NewModel.predict-445"><a href="#NewModel.predict-445"><span class="linenos">445</span></a>        <span class="n">all_obj_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="o">+</span>
</span><span id="NewModel.predict-446"><a href="#NewModel.predict-446"><span class="linenos">446</span></a>                          <span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="p">[]))</span>
</span><span id="NewModel.predict-447"><a href="#NewModel.predict-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">context_ids</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span> <span class="n">all_obj_ids</span><span class="p">):</span>
</span><span id="NewModel.predict-448"><a href="#NewModel.predict-448"><span class="linenos">448</span></a>            <span class="c1"># Returning here because the case where object ids in the context do not match the ids found in the annotations is not supported.</span>
</span><span id="NewModel.predict-449"><a href="#NewModel.predict-449"><span class="linenos">449</span></a>            <span class="c1"># This remains an open issue but is not considered a substantial problem.</span>
</span><span id="NewModel.predict-450"><a href="#NewModel.predict-450"><span class="linenos">450</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Context id </span><span class="si">{</span><span class="n">context_ids</span><span class="si">}</span><span class="s1"> not found in drafts result: </span><span class="si">{</span><span class="n">all_obj_ids</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="NewModel.predict-451"><a href="#NewModel.predict-451"><span class="linenos">451</span></a>                                      <span class="sa">f</span><span class="s1">&#39;TODO merge context and drafts&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-452"><a href="#NewModel.predict-452"><span class="linenos">452</span></a>
</span><span id="NewModel.predict-453"><a href="#NewModel.predict-453"><span class="linenos">453</span></a>        <span class="c1"># create a map from obj_id to integer</span>
</span><span id="NewModel.predict-454"><a href="#NewModel.predict-454"><span class="linenos">454</span></a>        <span class="n">obj_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)}</span>
</span><span id="NewModel.predict-455"><a href="#NewModel.predict-455"><span class="linenos">455</span></a>        <span class="c1"># find the last frame index</span>
</span><span id="NewModel.predict-456"><a href="#NewModel.predict-456"><span class="linenos">456</span></a>        <span class="c1"># if there is only one object, use the last frame of the object: continue tracking from last tracked frame</span>
</span><span id="NewModel.predict-457"><a href="#NewModel.predict-457"><span class="linenos">457</span></a>        <span class="c1"># if there are multiple objects, use the smallest frame index of all objects</span>
</span><span id="NewModel.predict-458"><a href="#NewModel.predict-458"><span class="linenos">458</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_obj_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="NewModel.predict-459"><a href="#NewModel.predict-459"><span class="linenos">459</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel.predict-460"><a href="#NewModel.predict-460"><span class="linenos">460</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel.predict-461"><a href="#NewModel.predict-461"><span class="linenos">461</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel.predict-462"><a href="#NewModel.predict-462"><span class="linenos">462</span></a>            <span class="n">first_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompts</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="NewModel.predict-463"><a href="#NewModel.predict-463"><span class="linenos">463</span></a>            <span class="c1"># the minimum of the maximum frame_idx of all objects grouped by id</span>
</span><span id="NewModel.predict-464"><a href="#NewModel.predict-464"><span class="linenos">464</span></a>            <span class="n">last_frame_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">)</span>
</span><span id="NewModel.predict-465"><a href="#NewModel.predict-465"><span class="linenos">465</span></a>        <span class="n">frames_count</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="NewModel.predict-466"><a href="#NewModel.predict-466"><span class="linenos">466</span></a>        <span class="n">fps</span> <span class="o">=</span> <span class="n">frames_count</span> <span class="o">/</span> <span class="n">duration</span>
</span><span id="NewModel.predict-467"><a href="#NewModel.predict-467"><span class="linenos">467</span></a>
</span><span id="NewModel.predict-468"><a href="#NewModel.predict-468"><span class="linenos">468</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="NewModel.predict-469"><a href="#NewModel.predict-469"><span class="linenos">469</span></a>            <span class="sa">f</span><span class="s1">&#39;Number of prompts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel.predict-470"><a href="#NewModel.predict-470"><span class="linenos">470</span></a>            <span class="sa">f</span><span class="s1">&#39;first frame index: </span><span class="si">{</span><span class="n">first_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel.predict-471"><a href="#NewModel.predict-471"><span class="linenos">471</span></a>            <span class="sa">f</span><span class="s1">&#39;last frame index: </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1">, &#39;</span>
</span><span id="NewModel.predict-472"><a href="#NewModel.predict-472"><span class="linenos">472</span></a>            <span class="sa">f</span><span class="s1">&#39;obj_ids: </span><span class="si">{</span><span class="n">obj_ids</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-473"><a href="#NewModel.predict-473"><span class="linenos">473</span></a>
</span><span id="NewModel.predict-474"><a href="#NewModel.predict-474"><span class="linenos">474</span></a>        <span class="n">frames_to_track</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_FRAMES_TO_TRACK</span><span class="p">,</span> <span class="n">frames_count</span> <span class="o">-</span> <span class="n">last_frame_idx</span><span class="p">)</span>
</span><span id="NewModel.predict-475"><a href="#NewModel.predict-475"><span class="linenos">475</span></a>
</span><span id="NewModel.predict-476"><a href="#NewModel.predict-476"><span class="linenos">476</span></a>        <span class="c1"># Split the video into frames</span>
</span><span id="NewModel.predict-477"><a href="#NewModel.predict-477"><span class="linenos">477</span></a>        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
</span><span id="NewModel.predict-478"><a href="#NewModel.predict-478"><span class="linenos">478</span></a>
</span><span id="NewModel.predict-479"><a href="#NewModel.predict-479"><span class="linenos">479</span></a>            <span class="c1"># # use persisted dir for debug</span>
</span><span id="NewModel.predict-480"><a href="#NewModel.predict-480"><span class="linenos">480</span></a>            <span class="c1"># temp_dir = &#39;/tmp/frames&#39;</span>
</span><span id="NewModel.predict-481"><a href="#NewModel.predict-481"><span class="linenos">481</span></a>            <span class="c1"># os.makedirs(temp_dir, exist_ok=True)</span>
</span><span id="NewModel.predict-482"><a href="#NewModel.predict-482"><span class="linenos">482</span></a>
</span><span id="NewModel.predict-483"><a href="#NewModel.predict-483"><span class="linenos">483</span></a>            <span class="c1"># get all frames</span>
</span><span id="NewModel.predict-484"><a href="#NewModel.predict-484"><span class="linenos">484</span></a>            <span class="n">frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_frames</span><span class="p">(</span>
</span><span id="NewModel.predict-485"><a href="#NewModel.predict-485"><span class="linenos">485</span></a>                <span class="n">video_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">,</span>
</span><span id="NewModel.predict-486"><a href="#NewModel.predict-486"><span class="linenos">486</span></a>                <span class="n">start_frame</span><span class="o">=</span><span class="n">first_frame_idx</span><span class="p">,</span>
</span><span id="NewModel.predict-487"><a href="#NewModel.predict-487"><span class="linenos">487</span></a>                <span class="n">end_frame</span><span class="o">=</span><span class="n">last_frame_idx</span> <span class="o">+</span> <span class="n">frames_to_track</span>
</span><span id="NewModel.predict-488"><a href="#NewModel.predict-488"><span class="linenos">488</span></a>            <span class="p">))</span>
</span><span id="NewModel.predict-489"><a href="#NewModel.predict-489"><span class="linenos">489</span></a>            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="NewModel.predict-490"><a href="#NewModel.predict-490"><span class="linenos">490</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video width=</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">, height=</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-491"><a href="#NewModel.predict-491"><span class="linenos">491</span></a>
</span><span id="NewModel.predict-492"><a href="#NewModel.predict-492"><span class="linenos">492</span></a>            <span class="c1"># get inference state</span>
</span><span id="NewModel.predict-493"><a href="#NewModel.predict-493"><span class="linenos">493</span></a>            <span class="n">inference_state</span> <span class="o">=</span> <span class="n">get_inference_state</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</span><span id="NewModel.predict-494"><a href="#NewModel.predict-494"><span class="linenos">494</span></a>            <span class="n">predictor</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span><span class="n">inference_state</span><span class="p">)</span>
</span><span id="NewModel.predict-495"><a href="#NewModel.predict-495"><span class="linenos">495</span></a>
</span><span id="NewModel.predict-496"><a href="#NewModel.predict-496"><span class="linenos">496</span></a>            <span class="c1"># Group prompts by &#39;obj_id&#39; and sort them by &#39;frame_idx&#39; in one step</span>
</span><span id="NewModel.predict-497"><a href="#NewModel.predict-497"><span class="linenos">497</span></a>            <span class="n">prompt_id_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="NewModel.predict-498"><a href="#NewModel.predict-498"><span class="linenos">498</span></a>            <span class="p">[</span><span class="n">prompt_id_dict</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="NewModel.predict-499"><a href="#NewModel.predict-499"><span class="linenos">499</span></a>
</span><span id="NewModel.predict-500"><a href="#NewModel.predict-500"><span class="linenos">500</span></a>            <span class="c1"># Sort the prompts and extract the highest frame index for each object ID</span>
</span><span id="NewModel.predict-501"><a href="#NewModel.predict-501"><span class="linenos">501</span></a>            <span class="n">highest_frames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prompts</span> <span class="ow">in</span>
</span><span id="NewModel.predict-502"><a href="#NewModel.predict-502"><span class="linenos">502</span></a>                              <span class="n">prompt_id_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">prompts</span><span class="p">]</span>
</span><span id="NewModel.predict-503"><a href="#NewModel.predict-503"><span class="linenos">503</span></a>
</span><span id="NewModel.predict-504"><a href="#NewModel.predict-504"><span class="linenos">504</span></a>            <span class="c1"># Get the minimum value of the highest frame indices</span>
</span><span id="NewModel.predict-505"><a href="#NewModel.predict-505"><span class="linenos">505</span></a>            <span class="n">prompt_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">highest_frames</span><span class="p">)</span> <span class="k">if</span> <span class="n">highest_frames</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="NewModel.predict-506"><a href="#NewModel.predict-506"><span class="linenos">506</span></a>
</span><span id="NewModel.predict-507"><a href="#NewModel.predict-507"><span class="linenos">507</span></a>            <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
</span><span id="NewModel.predict-508"><a href="#NewModel.predict-508"><span class="linenos">508</span></a>
</span><span id="NewModel.predict-509"><a href="#NewModel.predict-509"><span class="linenos">509</span></a>                <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;frame_idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_frame_idx</span>
</span><span id="NewModel.predict-510"><a href="#NewModel.predict-510"><span class="linenos">510</span></a>                <span class="c1"># sam 2 not predict other frame if are present prompts after the frame: the prompt must be set in the same frame for each object</span>
</span><span id="NewModel.predict-511"><a href="#NewModel.predict-511"><span class="linenos">511</span></a>                <span class="k">if</span> <span class="n">frame_idx</span> <span class="o">&gt;</span> <span class="n">prompt_idx</span><span class="p">:</span>
</span><span id="NewModel.predict-512"><a href="#NewModel.predict-512"><span class="linenos">512</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prompt frame index </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s1"> is out of bounds&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-513"><a href="#NewModel.predict-513"><span class="linenos">513</span></a>                    <span class="k">continue</span>
</span><span id="NewModel.predict-514"><a href="#NewModel.predict-514"><span class="linenos">514</span></a>
</span><span id="NewModel.predict-515"><a href="#NewModel.predict-515"><span class="linenos">515</span></a>
</span><span id="NewModel.predict-516"><a href="#NewModel.predict-516"><span class="linenos">516</span></a>                <span class="k">if</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
</span><span id="NewModel.predict-517"><a href="#NewModel.predict-517"><span class="linenos">517</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="NewModel.predict-518"><a href="#NewModel.predict-518"><span class="linenos">518</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel.predict-519"><a href="#NewModel.predict-519"><span class="linenos">519</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel.predict-520"><a href="#NewModel.predict-520"><span class="linenos">520</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="NewModel.predict-521"><a href="#NewModel.predict-521"><span class="linenos">521</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel.predict-522"><a href="#NewModel.predict-522"><span class="linenos">522</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel.predict-523"><a href="#NewModel.predict-523"><span class="linenos">523</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="NewModel.predict-524"><a href="#NewModel.predict-524"><span class="linenos">524</span></a>                        <span class="n">points</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-525"><a href="#NewModel.predict-525"><span class="linenos">525</span></a>                        <span class="n">labels</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</span><span id="NewModel.predict-526"><a href="#NewModel.predict-526"><span class="linenos">526</span></a>                    <span class="p">)</span>
</span><span id="NewModel.predict-527"><a href="#NewModel.predict-527"><span class="linenos">527</span></a>                <span class="k">elif</span> <span class="n">PROMPT_TYPE</span> <span class="o">==</span> <span class="s1">&#39;box&#39;</span><span class="p">:</span>
</span><span id="NewModel.predict-528"><a href="#NewModel.predict-528"><span class="linenos">528</span></a>                    <span class="c1"># multiply points by the frame size</span>
</span><span id="NewModel.predict-529"><a href="#NewModel.predict-529"><span class="linenos">529</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel.predict-530"><a href="#NewModel.predict-530"><span class="linenos">530</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel.predict-531"><a href="#NewModel.predict-531"><span class="linenos">531</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width</span>
</span><span id="NewModel.predict-532"><a href="#NewModel.predict-532"><span class="linenos">532</span></a>                    <span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height</span>
</span><span id="NewModel.predict-533"><a href="#NewModel.predict-533"><span class="linenos">533</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">add_new_points_or_box</span><span class="p">(</span>
</span><span id="NewModel.predict-534"><a href="#NewModel.predict-534"><span class="linenos">534</span></a>                        <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel.predict-535"><a href="#NewModel.predict-535"><span class="linenos">535</span></a>                        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
</span><span id="NewModel.predict-536"><a href="#NewModel.predict-536"><span class="linenos">536</span></a>                        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_ids</span><span class="p">[</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;obj_id&#39;</span><span class="p">]],</span>
</span><span id="NewModel.predict-537"><a href="#NewModel.predict-537"><span class="linenos">537</span></a>                        <span class="n">box</span><span class="o">=</span><span class="n">prompt</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-538"><a href="#NewModel.predict-538"><span class="linenos">538</span></a>                    <span class="p">)</span>
</span><span id="NewModel.predict-539"><a href="#NewModel.predict-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel.predict-540"><a href="#NewModel.predict-540"><span class="linenos">540</span></a>              <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;./debug-frames&#39;</span>
</span><span id="NewModel.predict-541"><a href="#NewModel.predict-541"><span class="linenos">541</span></a>              <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NewModel.predict-542"><a href="#NewModel.predict-542"><span class="linenos">542</span></a>
</span><span id="NewModel.predict-543"><a href="#NewModel.predict-543"><span class="linenos">543</span></a>            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="NewModel.predict-544"><a href="#NewModel.predict-544"><span class="linenos">544</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Propagating in video from frame </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">last_frame_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">frames_to_track</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-545"><a href="#NewModel.predict-545"><span class="linenos">545</span></a>            <span class="k">for</span> <span class="n">out_frame_idx</span><span class="p">,</span> <span class="n">out_obj_ids</span><span class="p">,</span> <span class="n">out_mask_logits</span> <span class="ow">in</span> <span class="n">predictor</span><span class="o">.</span><span class="n">propagate_in_video</span><span class="p">(</span>
</span><span id="NewModel.predict-546"><a href="#NewModel.predict-546"><span class="linenos">546</span></a>                <span class="n">inference_state</span><span class="o">=</span><span class="n">inference_state</span><span class="p">,</span>
</span><span id="NewModel.predict-547"><a href="#NewModel.predict-547"><span class="linenos">547</span></a>                <span class="n">start_frame_idx</span><span class="o">=</span><span class="n">last_frame_idx</span><span class="p">,</span>
</span><span id="NewModel.predict-548"><a href="#NewModel.predict-548"><span class="linenos">548</span></a>                <span class="n">max_frame_num_to_track</span><span class="o">=</span><span class="n">frames_to_track</span>
</span><span id="NewModel.predict-549"><a href="#NewModel.predict-549"><span class="linenos">549</span></a>            <span class="p">):</span>
</span><span id="NewModel.predict-550"><a href="#NewModel.predict-550"><span class="linenos">550</span></a>                <span class="n">real_frame_idx</span> <span class="o">=</span> <span class="n">out_frame_idx</span> <span class="o">+</span> <span class="n">first_frame_idx</span>
</span><span id="NewModel.predict-551"><a href="#NewModel.predict-551"><span class="linenos">551</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out_obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_obj_ids</span><span class="p">):</span>
</span><span id="NewModel.predict-552"><a href="#NewModel.predict-552"><span class="linenos">552</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_mask_logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="NewModel.predict-553"><a href="#NewModel.predict-553"><span class="linenos">553</span></a>
</span><span id="NewModel.predict-554"><a href="#NewModel.predict-554"><span class="linenos">554</span></a>                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel.predict-555"><a href="#NewModel.predict-555"><span class="linenos">555</span></a>
</span><span id="NewModel.predict-556"><a href="#NewModel.predict-556"><span class="linenos">556</span></a>                      <span class="c1"># to debug, save the mask as an image</span>
</span><span id="NewModel.predict-557"><a href="#NewModel.predict-557"><span class="linenos">557</span></a>                      <span class="bp">self</span><span class="o">.</span><span class="n">dump_image_with_mask</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">out_frame_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">debug_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">out_frame_idx</span><span class="si">:</span><span class="s1">05d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">out_obj_id</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">out_obj_id</span><span class="p">,</span> <span class="n">random_color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NewModel.predict-558"><a href="#NewModel.predict-558"><span class="linenos">558</span></a>
</span><span id="NewModel.predict-559"><a href="#NewModel.predict-559"><span class="linenos">559</span></a>                    <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_mask_to_bbox</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="NewModel.predict-560"><a href="#NewModel.predict-560"><span class="linenos">560</span></a>                    <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
</span><span id="NewModel.predict-561"><a href="#NewModel.predict-561"><span class="linenos">561</span></a>                        <span class="n">obj_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">out_obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="NewModel.predict-562"><a href="#NewModel.predict-562"><span class="linenos">562</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="NewModel.predict-563"><a href="#NewModel.predict-563"><span class="linenos">563</span></a>                        <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel.predict-564"><a href="#NewModel.predict-564"><span class="linenos">564</span></a>                            <span class="s1">&#39;frame&#39;</span><span class="p">:</span> <span class="n">real_frame_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="NewModel.predict-565"><a href="#NewModel.predict-565"><span class="linenos">565</span></a>                            <span class="c1"># &#39;x&#39;: bbox[&#39;x&#39;] / width * 100,</span>
</span><span id="NewModel.predict-566"><a href="#NewModel.predict-566"><span class="linenos">566</span></a>                            <span class="c1"># &#39;y&#39;: bbox[&#39;y&#39;] / height * 100,</span>
</span><span id="NewModel.predict-567"><a href="#NewModel.predict-567"><span class="linenos">567</span></a>                            <span class="c1"># &#39;width&#39;: bbox[&#39;width&#39;] / width * 100,</span>
</span><span id="NewModel.predict-568"><a href="#NewModel.predict-568"><span class="linenos">568</span></a>                            <span class="c1"># &#39;height&#39;: bbox[&#39;height&#39;] / height * 100,</span>
</span><span id="NewModel.predict-569"><a href="#NewModel.predict-569"><span class="linenos">569</span></a>                            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-570"><a href="#NewModel.predict-570"><span class="linenos">570</span></a>                            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-571"><a href="#NewModel.predict-571"><span class="linenos">571</span></a>                            <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-572"><a href="#NewModel.predict-572"><span class="linenos">572</span></a>                            <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-573"><a href="#NewModel.predict-573"><span class="linenos">573</span></a>                            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="NewModel.predict-574"><a href="#NewModel.predict-574"><span class="linenos">574</span></a>                            <span class="s1">&#39;rotation&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="NewModel.predict-575"><a href="#NewModel.predict-575"><span class="linenos">575</span></a>                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">out_frame_idx</span> <span class="o">/</span> <span class="n">fps</span>
</span><span id="NewModel.predict-576"><a href="#NewModel.predict-576"><span class="linenos">576</span></a>                        <span class="p">})</span>
</span><span id="NewModel.predict-577"><a href="#NewModel.predict-577"><span class="linenos">577</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NewModel.predict-578"><a href="#NewModel.predict-578"><span class="linenos">578</span></a>            <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">all_obj_ids</span><span class="p">:</span>
</span><span id="NewModel.predict-579"><a href="#NewModel.predict-579"><span class="linenos">579</span></a>                <span class="c1"># find the context to use by searching on drafts by obj_id</span>
</span><span id="NewModel.predict-580"><a href="#NewModel.predict-580"><span class="linenos">580</span></a>                <span class="n">context_result_sequence</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="p">[])</span>
</span><span id="NewModel.predict-581"><a href="#NewModel.predict-581"><span class="linenos">581</span></a>                <span class="c1"># take the old sequence only for the frames before the first frame of the new sequence</span>
</span><span id="NewModel.predict-582"><a href="#NewModel.predict-582"><span class="linenos">582</span></a>                <span class="c1"># and after the last frame of the new sequence</span>
</span><span id="NewModel.predict-583"><a href="#NewModel.predict-583"><span class="linenos">583</span></a>                <span class="n">new_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span> <span class="o">+</span> \
</span><span id="NewModel.predict-584"><a href="#NewModel.predict-584"><span class="linenos">584</span></a>                               <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="NewModel.predict-585"><a href="#NewModel.predict-585"><span class="linenos">585</span></a>                               <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">context_result_sequence</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sequences</span><span class="p">[</span><span class="n">obj_id</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;frame&#39;</span><span class="p">]]</span>
</span><span id="NewModel.predict-586"><a href="#NewModel.predict-586"><span class="linenos">586</span></a>                <span class="c1"># take the old labels: take from context if present, otherwise from drafts</span>
</span><span id="NewModel.predict-587"><a href="#NewModel.predict-587"><span class="linenos">587</span></a>                <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
</span><span id="NewModel.predict-588"><a href="#NewModel.predict-588"><span class="linenos">588</span></a>                         <span class="nb">next</span><span class="p">((</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="NewModel.predict-589"><a href="#NewModel.predict-589"><span class="linenos">589</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="NewModel.predict-590"><a href="#NewModel.predict-590"><span class="linenos">590</span></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="NewModel.predict-591"><a href="#NewModel.predict-591"><span class="linenos">591</span></a>                        <span class="s1">&#39;framesCount&#39;</span><span class="p">:</span> <span class="n">frames_count</span><span class="p">,</span>
</span><span id="NewModel.predict-592"><a href="#NewModel.predict-592"><span class="linenos">592</span></a>                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
</span><span id="NewModel.predict-593"><a href="#NewModel.predict-593"><span class="linenos">593</span></a>                        <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">new_sequence</span><span class="p">,</span>
</span><span id="NewModel.predict-594"><a href="#NewModel.predict-594"><span class="linenos">594</span></a>                        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">labels</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="NewModel.predict-595"><a href="#NewModel.predict-595"><span class="linenos">595</span></a>                    <span class="p">},</span>
</span><span id="NewModel.predict-596"><a href="#NewModel.predict-596"><span class="linenos">596</span></a>                    <span class="s1">&#39;from_name&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span>
</span><span id="NewModel.predict-597"><a href="#NewModel.predict-597"><span class="linenos">597</span></a>                    <span class="s1">&#39;to_name&#39;</span><span class="p">:</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span>
</span><span id="NewModel.predict-598"><a href="#NewModel.predict-598"><span class="linenos">598</span></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;videorectangle&#39;</span><span class="p">,</span>
</span><span id="NewModel.predict-599"><a href="#NewModel.predict-599"><span class="linenos">599</span></a>                    <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span>
</span><span id="NewModel.predict-600"><a href="#NewModel.predict-600"><span class="linenos">600</span></a>                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">obj_id</span>
</span><span id="NewModel.predict-601"><a href="#NewModel.predict-601"><span class="linenos">601</span></a>                <span class="p">})</span>
</span><span id="NewModel.predict-602"><a href="#NewModel.predict-602"><span class="linenos">602</span></a>
</span><span id="NewModel.predict-603"><a href="#NewModel.predict-603"><span class="linenos">603</span></a>
</span><span id="NewModel.predict-604"><a href="#NewModel.predict-604"><span class="linenos">604</span></a>            <span class="n">prediction</span> <span class="o">=</span> <span class="n">PredictionValue</span><span class="p">(</span>
</span><span id="NewModel.predict-605"><a href="#NewModel.predict-605"><span class="linenos">605</span></a>                <span class="n">model_version</span><span class="o">=</span><span class="n">MODEL_CHECKPOINT</span><span class="p">,</span>
</span><span id="NewModel.predict-606"><a href="#NewModel.predict-606"><span class="linenos">606</span></a>                <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="NewModel.predict-607"><a href="#NewModel.predict-607"><span class="linenos">607</span></a>                <span class="n">result</span><span class="o">=</span><span class="n">result</span>
</span><span id="NewModel.predict-608"><a href="#NewModel.predict-608"><span class="linenos">608</span></a>            <span class="p">)</span>
</span><span id="NewModel.predict-609"><a href="#NewModel.predict-609"><span class="linenos">609</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prediction: </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-610"><a href="#NewModel.predict-610"><span class="linenos">610</span></a>            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
</span><span id="NewModel.predict-611"><a href="#NewModel.predict-611"><span class="linenos">611</span></a>              <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prediction.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="NewModel.predict-612"><a href="#NewModel.predict-612"><span class="linenos">612</span></a>                  <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
</span><span id="NewModel.predict-613"><a href="#NewModel.predict-613"><span class="linenos">613</span></a>
</span><span id="NewModel.predict-614"><a href="#NewModel.predict-614"><span class="linenos">614</span></a>            <span class="k">if</span> <span class="n">ANNOTATION_WORKAROUND</span><span class="p">:</span>
</span><span id="NewModel.predict-615"><a href="#NewModel.predict-615"><span class="linenos">615</span></a>                <span class="c1"># this is a workaround to update the annotation in the Label Studio since using the model response shows all the objects with the same label</span>
</span><span id="NewModel.predict-616"><a href="#NewModel.predict-616"><span class="linenos">616</span></a>                <span class="c1"># also if the label is different for each object</span>
</span><span id="NewModel.predict-617"><a href="#NewModel.predict-617"><span class="linenos">617</span></a>                <span class="n">client</span> <span class="o">=</span> <span class="n">LabelStudio</span><span class="p">(</span>
</span><span id="NewModel.predict-618"><a href="#NewModel.predict-618"><span class="linenos">618</span></a>                    <span class="n">api_key</span><span class="o">=</span><span class="n">LABEL_STUDIO_API_KEY</span><span class="p">,</span>
</span><span id="NewModel.predict-619"><a href="#NewModel.predict-619"><span class="linenos">619</span></a>                <span class="p">)</span>
</span><span id="NewModel.predict-620"><a href="#NewModel.predict-620"><span class="linenos">620</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NewModel.predict-621"><a href="#NewModel.predict-621"><span class="linenos">621</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating new annotation&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-622"><a href="#NewModel.predict-622"><span class="linenos">622</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="NewModel.predict-623"><a href="#NewModel.predict-623"><span class="linenos">623</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="NewModel.predict-624"><a href="#NewModel.predict-624"><span class="linenos">624</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="NewModel.predict-625"><a href="#NewModel.predict-625"><span class="linenos">625</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-626"><a href="#NewModel.predict-626"><span class="linenos">626</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="NewModel.predict-627"><a href="#NewModel.predict-627"><span class="linenos">627</span></a>                    <span class="p">)</span>
</span><span id="NewModel.predict-628"><a href="#NewModel.predict-628"><span class="linenos">628</span></a>                    <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="NewModel.predict-629"><a href="#NewModel.predict-629"><span class="linenos">629</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NewModel.predict-630"><a href="#NewModel.predict-630"><span class="linenos">630</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating annotation: </span><span class="si">{</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;annotations&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="NewModel.predict-631"><a href="#NewModel.predict-631"><span class="linenos">631</span></a>                    <span class="n">ann</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="NewModel.predict-632"><a href="#NewModel.predict-632"><span class="linenos">632</span></a>                        <span class="nb">id</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="NewModel.predict-633"><a href="#NewModel.predict-633"><span class="linenos">633</span></a>                        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="NewModel.predict-634"><a href="#NewModel.predict-634"><span class="linenos">634</span></a>                        <span class="n">task</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
</span><span id="NewModel.predict-635"><a href="#NewModel.predict-635"><span class="linenos">635</span></a>                        <span class="n">project</span><span class="o">=</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
</span><span id="NewModel.predict-636"><a href="#NewModel.predict-636"><span class="linenos">636</span></a>                    <span class="p">)</span> <span class="c1"># perche se non lo faccio nella UI mette tutti gli oggetti con la stessa label! sempre!</span>
</span><span id="NewModel.predict-637"><a href="#NewModel.predict-637"><span class="linenos">637</span></a>                <span class="c1"># convert annotation to draft making POST request to http://&lt;IP&gt;/api/annotations/{id}/convert-to-draft</span>
</span><span id="NewModel.predict-638"><a href="#NewModel.predict-638"><span class="linenos">638</span></a>                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_URL&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/api/annotations/</span><span class="si">{</span><span class="n">ann</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">/convert-to-draft&#39;</span>
</span><span id="NewModel.predict-639"><a href="#NewModel.predict-639"><span class="linenos">639</span></a>                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NewModel.predict-640"><a href="#NewModel.predict-640"><span class="linenos">640</span></a>                    <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LABEL_STUDIO_API_KEY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="NewModel.predict-641"><a href="#NewModel.predict-641"><span class="linenos">641</span></a>                <span class="p">}</span>
</span><span id="NewModel.predict-642"><a href="#NewModel.predict-642"><span class="linenos">642</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="NewModel.predict-643"><a href="#NewModel.predict-643"><span class="linenos">643</span></a>            <span class="c1"># raise NotImplementedError(&#39;Stop here&#39;)</span>
</span><span id="NewModel.predict-644"><a href="#NewModel.predict-644"><span class="linenos">644</span></a>            <span class="k">return</span> <span class="n">ModelResponse</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="p">[</span><span class="n">prediction</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Run the prediction to generate segmentation masks for a given set of video frames.</p>

<p>The model:</p>

<ol>
<li>Extracts prompts (boxes/points) from the given tasks and drafts.</li>
<li>Uses the SAM2 predictor to track the object(s) through frames.</li>
<li>Updates annotations in Label Studio with the new masks and bounding boxes.</li>
</ol>

<h2 id="parameters">Parameters</h2>

<p>tasks : list of dict
    List of tasks to be annotated, each containing video data and drafts or annotations.
context : dict, optional
    Additional context with annotation results. If no drafts are found, context is used as a fallback.
**kwargs
    Additional keyword arguments (unused).</p>

<h2 id="returns">Returns</h2>

<p>ModelResponse
    A structured response containing updated annotations for Label Studio.</p>
</div>


                            </div>
                </section>
    </main>
</body>
</html>